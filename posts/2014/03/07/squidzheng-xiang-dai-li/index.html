<!DOCTYPE html>
<html lang="zh_cn">
<head>
	<title>squid正向代理 | Eleven.I386's Blog</title>
	<meta charset="utf-8" />
    <meta name="author" content="eleven.i386">
	<link rel="stylesheet" href="http://eleveni386.7axu.com/theme/css/franticworld.css" type="text/css" />
	<link href="http://eleveni386.7axu.com/theme/css/pygments.css" rel="stylesheet">
</head>
<body background="http://eleveni386.7axu.com/theme/img/pattern.png">
		<div class="nav-banner">
		<a href="http://eleveni386.7axu.com">Eleven.I386's Blog</a>
		</div>
		
		<div class="content">

<div class="metabox">
	<p class="metaday">066</p>
	<p class="metayear">2014</p>
	<p class="metacategory">Linux运维</p>
</div>
<div class="arcticlecontentbox">
	<div class="articlecontent">
		<a class="articletitle" href="/posts/2014/03/07/squidzheng-xiang-dai-li/ " >squid正向代理</a>
		<h2>匿名代理</h2>
<p>squid 要做到匿名代理 只需要添加</p>
<div class="highlight"><pre><span class="n">header_access</span> <span class="n">Via</span> <span class="n">deny</span> <span class="n">all</span> 
<span class="n">header_access</span>  <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="n">deny</span> <span class="n">all</span>
</pre></div>


<p>即可</p>
<h2>代理验证</h2>
<p>谁都不想自己的代理服务器被他人随意拿来使用.. 于是 我们就需要给代理服务器加上密码</p>
<div class="highlight"><pre><span class="n">auth_param</span> <span class="n">basic</span> <span class="n">program</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">eleven</span><span class="o">/</span><span class="n">squid2</span><span class="mf">.7</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ncsa_auth</span>
<span class="n">auth_param</span> <span class="n">basic</span> <span class="n">children</span> <span class="mi">1</span>
<span class="n">auth_param</span> <span class="n">basic</span> <span class="n">realm</span> <span class="s">&quot;Welcome to eleven&#39;s proxy server&quot;</span>
<span class="n">auth_param</span> <span class="n">basic</span> <span class="n">credentialsttl</span> <span class="mi">12</span> <span class="n">hours</span>
</pre></div>


<p>这里的<strong>ncsa_auth</strong> 是自己写的shell脚本, 我的squid版本是2.7, 没有自带ncsa_auth程序</p>
<h2>一个简单的代理验证脚本</h2>
<div class="highlight"><pre><span class="k">while</span> <span class="nb">true</span><span class="p">;</span>
<span class="k">do</span>
    <span class="n">read</span> <span class="n">line</span>
    <span class="n">username</span><span class="o">=</span><span class="err">`</span><span class="n">echo</span> <span class="err">$</span><span class="n">line</span> <span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">1</span><span class="p">}</span><span class="err">&#39;`</span><span class="p">;</span>
    <span class="n">password</span><span class="o">=</span><span class="err">`</span><span class="n">echo</span> <span class="err">$</span><span class="n">line</span> <span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">2</span><span class="p">}</span><span class="err">&#39;`</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">[</span> <span class="s">&quot;x$username&quot;</span> <span class="o">==</span> <span class="s">&quot;xeleven&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
        <span class="k">if</span> <span class="p">[</span> <span class="s">&quot;x$password&quot;</span> <span class="o">==</span> <span class="s">&quot;x*****&quot;</span> <span class="p">]</span>
        <span class="n">then</span>
            <span class="n">echo</span> <span class="n">OK</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">echo</span> <span class="n">Err</span><span class="p">;</span>
        <span class="n">fi</span>  
    <span class="k">else</span>
        <span class="n">echo</span> <span class="n">Err</span><span class="p">;</span>
    <span class="n">fi</span>  
<span class="n">done</span>
</pre></div>


<p>这个脚本有点类似之前的<a href="http://eleveni386.7axu.com/posts/2013/10/13/squid-url-tiao-zhuan/"><strong>squid url跳转</strong></a>
使用的脚本. 都是脚本从squid处接收需要处理的信息, 脚本处理完毕之后返回给squid结果</p>
<h2>squid正向代理, 搭建 http 代理服务器</h2>
<p>以下是一份完整的squid正向代理的配置文件</p>
<div class="highlight"><pre><span class="n">auth_param</span> <span class="n">basic</span> <span class="n">program</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">eleven</span><span class="o">/</span><span class="n">squid2</span><span class="mf">.7</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ncsa_auth</span>
<span class="n">auth_param</span> <span class="n">basic</span> <span class="n">children</span> <span class="mi">1</span>
<span class="n">auth_param</span> <span class="n">basic</span> <span class="n">realm</span> <span class="s">&quot;Welcome to eleven&#39;s proxy server&quot;</span>
<span class="n">auth_param</span> <span class="n">basic</span> <span class="n">credentialsttl</span> <span class="mi">12</span> <span class="n">hours</span>
<span class="n">acl</span> <span class="n">all</span> <span class="n">src</span> <span class="n">all</span> 
<span class="n">acl</span> <span class="n">squid_user</span> <span class="n">proxy_auth</span> <span class="n">REQUIRED</span>
<span class="n">acl</span> <span class="n">manager</span> <span class="n">proto</span> <span class="n">cache_object</span>
<span class="n">acl</span> <span class="n">localhost</span> <span class="n">src</span> <span class="mf">127.0.0.1</span><span class="o">/</span><span class="mi">32</span>
<span class="n">acl</span> <span class="n">SSL_ports</span> <span class="n">port</span> <span class="mi">443</span> 
<span class="n">acl</span> <span class="n">Safe_ports</span> <span class="n">port</span> <span class="mi">80</span>      <span class="err">#</span> <span class="n">http</span>
<span class="n">acl</span> <span class="n">Safe_ports</span> <span class="n">port</span> <span class="mi">21</span>      <span class="err">#</span> <span class="n">ftp</span>
<span class="n">acl</span> <span class="n">Safe_ports</span> <span class="n">port</span> <span class="mi">443</span>     <span class="err">#</span> <span class="n">https</span>
<span class="n">acl</span> <span class="n">CONNECT</span> <span class="n">method</span> <span class="n">CONNECT</span>
<span class="n">http_access</span> <span class="n">allow</span> <span class="n">manager</span> <span class="n">localhost</span>
<span class="n">http_access</span> <span class="n">deny</span> <span class="n">manager</span>
<span class="n">http_access</span> <span class="n">deny</span> <span class="o">!</span><span class="n">Safe_ports</span>
<span class="n">http_access</span> <span class="n">deny</span> <span class="n">CONNECT</span> <span class="o">!</span><span class="n">SSL_ports</span>
<span class="n">http_access</span> <span class="n">allow</span> <span class="n">localhost</span>
<span class="cp"># 允许密码用户登录</span>
<span class="n">http_access</span> <span class="n">allow</span> <span class="n">squid_user</span>
<span class="cp"># 拒绝其他所有请求</span>
<span class="n">http_access</span> <span class="n">deny</span> <span class="n">all</span>
<span class="cp"># Squid的监听端口</span>
<span class="n">http_port</span> <span class="o">****</span> <span class="err">#</span> <span class="err">不准暴力猜解我的密码</span><span class="p">.</span> <span class="err">哼</span>
<span class="cp"># DNS 域名服务器配置</span>
<span class="n">dns_nameservers</span> <span class="mf">8.8.8.8</span>
<span class="cp"># 启动squid2.7的用户</span>
<span class="n">cache_effective_user</span> <span class="n">eleven</span>
<span class="n">cache_effective_group</span> <span class="n">eleven</span>
<span class="cp"># squid2.7访问日志; 调试时开启</span>
<span class="cp">#cache_access_log /var/log/squid/access.log</span>
<span class="cp">#cache_log /var/log/squid/cache.log</span>
<span class="cp"># squid2.7挂掉后，core文件位置</span>
<span class="n">coredump_dir</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">eleven</span><span class="o">/</span><span class="n">squid2</span><span class="mf">.7</span><span class="o">/</span>
<span class="cp"># 高匿</span>
<span class="n">header_access</span> <span class="n">Via</span> <span class="n">deny</span> <span class="n">all</span>
<span class="n">header_access</span>  <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="n">deny</span> <span class="n">all</span>
<span class="cp"># 出现cgi-bin或者？的URL不予缓存</span>
<span class="n">hierarchy_stoplist</span> <span class="n">cgi</span><span class="o">-</span><span class="n">bin</span> <span class="o">?</span> <span class="err">\</span><span class="p">.</span><span class="n">php</span>
<span class="n">acl</span> <span class="n">QUERY</span> <span class="n">urlpath_regex</span> <span class="o">-</span><span class="n">i</span> <span class="n">cgi</span><span class="o">-</span><span class="n">bin</span> <span class="p">[</span><span class="o">^</span><span class="n">html</span><span class="p">]</span><span class="err">\</span><span class="o">?</span> <span class="err">\</span><span class="p">.</span><span class="n">asp</span> <span class="err">\</span><span class="p">.</span><span class="n">php</span> <span class="err">\</span><span class="p">.</span><span class="n">jsp</span> <span class="err">\</span><span class="p">.</span><span class="n">cgi</span>
<span class="n">acl</span> <span class="n">download</span> <span class="n">urlpath_regex</span> <span class="o">-</span><span class="n">i</span> <span class="err">\</span><span class="p">.</span><span class="n">avi</span><span class="err">$</span> <span class="err">\</span><span class="p">.</span><span class="n">rmvb</span><span class="err">$</span> <span class="err">\</span><span class="p">.</span><span class="n">rm</span><span class="err">$</span> <span class="err">\</span><span class="p">.</span><span class="n">ra</span><span class="err">$</span> <span class="err">\</span><span class="p">.</span><span class="n">ram</span><span class="err">$</span> <span class="err">\</span><span class="p">.</span><span class="n">mpe</span><span class="err">$</span> <span class="err">\</span><span class="p">.</span><span class="n">smi</span><span class="err">$</span>
<span class="n">cache</span> <span class="n">deny</span> <span class="n">QUERY</span>
<span class="n">cache</span> <span class="n">deny</span> <span class="n">download</span>
<span class="cp"># 磁盘缓存目录</span>
<span class="n">cache_dir</span> <span class="n">ufs</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">eleven</span><span class="o">/</span><span class="n">squid2</span><span class="mf">.7</span><span class="o">/</span><span class="n">cdir</span> <span class="mi">500</span> <span class="mi">16</span> <span class="mi">256</span>
<span class="cp"># 内存缓冲大小</span>
<span class="n">cache_mem</span> <span class="mi">2</span><span class="n">M</span>
<span class="cp"># 刷新缓存规则</span>
<span class="n">refresh_pattern</span> <span class="o">^</span><span class="n">ftp</span><span class="o">:</span>       <span class="mi">1440</span>    <span class="mi">20</span><span class="o">%</span> <span class="mi">10080</span>
<span class="n">refresh_pattern</span> <span class="o">-</span><span class="n">i</span> <span class="p">(</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/|</span><span class="err">\</span><span class="o">?</span><span class="p">)</span> <span class="mi">0</span> <span class="mi">0</span><span class="o">%</span>  <span class="mi">0</span>
<span class="n">refresh_pattern</span> <span class="p">.</span>       <span class="mi">0</span>   <span class="mi">20</span><span class="o">%</span> <span class="mi">4320</span>
</pre></div>


<h2>加密本地至squid的请求</h2>
<p>前面的文章里面讲解过了使用<strong>Stunnel</strong>做加密解密, 本地使用<strong>socat</strong>做数据转发, 采用
<strong>openssl</strong> 加密本地http数据,</p>
<p><a href="http://eleveni386.7axu.com/posts/2013/05/17/jia-mi-ni-de-httpqing-qiu-chuan-qiang/">参考文章</a></p>
<h2>结束</h2>
<p>至此, 一个全新的支持https访问的 http代理就搭建成功了. 第一次访问会要求你输入帐号和密码
相信看过本人此前的文章 都知道我曾经使用了一个叫做<strong>kangle</strong>的工具 搭建了一个http代理.
不知道从什么时候开始 <strong>kangle</strong> 搭建的代理 无法访问https协议的 站点. 于是,才迫使我
转而使用squid. </p>
	</div>
	
	<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	   var disqus_identifier = "posts/2014/03/07/squidzheng-xiang-dai-li/";
	   (function() {
			var dsq = document.createElement('script');
			dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = 'http://eleveni386sblog.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] ||
			 document.getElementsByTagName('body')[0]).appendChild(dsq);
	  })();
	</script>
	</div>
	       
</div>

		</div>
		
		<div class="sidebar">
<div class="sidebarcategory">
<h4>Categories</h4>
	<li><a href="http://eleveni386.7axu.com/category/jian-kong-xi-tong.html">监控系统</a></li>
	<li><a href="http://eleveni386.7axu.com/category/linuxyun-wei.html">Linux运维</a></li>
	<li><a href="http://eleveni386.7axu.com/category/linuxzhuo-mian.html">Linux桌面</a></li>
	<li><a href="http://eleveni386.7axu.com/category/mu-ma-bing-du.html">木马病毒</a></li>
	<li><a href="http://eleveni386.7axu.com/category/python.html">python</a></li>
	<li><a href="http://eleveni386.7axu.com/category/ruan-jian-tui-jian.html">软件推荐</a></li>
	<li><a href="http://eleveni386.7axu.com/category/vim.html">vim</a></li>
</div>

<div class="sidebarpages">
</div>

<div class="sidebarblogroll">
<h4>Blogroll</h4>
    <li><a href="http://www.linuxzen.com/" target="_blank">cold</a></li>
    <li><a href="http://lilydjwg.is-programmer.com/" target="_blank">依云</a></li>
    <li><a href="https://www.7axu.com/" target="_blank">小柒'网络志</a></li>
    <li><a href="http://neteue.com/" target="_blank">小邪兽</a></li>
    <li><a href="http://supercat-lab.org/" target="_blank">老猫</a></li>
    <li><a href="http://evilbinary.org/" target="_blank">ee</a></li>
    <li><a href="http://www.awaysoft.com/taor/" target="_blank">ACTom</a></li>
    <li><a href="http://blog.woodelf.org/" target="_blank">woodelf</a></li>
</div>

<div class="sidebarsocial">
<h4>Social</h4>
    <li><a href="https://github.com/eleveni386">GitHub</a></li>
    <li><a href="https://plus.google.com/102949387282276761880">G+</a></li>
</div>		</div>
		
		<footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>,
				Theme by <a href="http://frantic1048.com/">Frantic1048</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>