<!DOCTYPE html>
<html lang="zh_cn">
<head>


    <meta name="tags" contents="python" />
    <meta name="tags" contents="桌面" />
    <meta name="tags" contents="运维" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://eleveni386.7axu.com">Eleven.I386's Blog <strong></strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="http://eleveni386.7axu.com/posts/2013/06/03/pythondai-cookiesfang-wen/" rel="bookmark"
         title="Permalink to python带cookies访问">python带cookies访问</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2013-06-03T00:00:00">
      一 03 六月 2013
    </abbr>
    <address class="vcard author">
      By <a class="url fn" href="http://eleveni386.7axu.com/author/eleveni386.html">eleven.i386</a>
    </address>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>本人是运维一枚,使用次数最多的就是Vandyke的<a href="https://secure.vandyke.com/cgi-bin/download_form.php?pid=securecrt_ubuntu1264_deb_71&amp;st=4&amp;">SecureCRT</a>.
在win系统下面有各种大牛
破解的scrt版本,但是在咱debian下面 就只能使用官方正版的,但是因为scrt是收费的,
而且还死贵死贵($99), 咱这种中下农,搞不起这货, 只能使用它的免费30天,时间一到,
要么就是删除它的认证文件,要么就是卸载原有的,然后重新安装, 非常麻烦…</p>
<p>于是就想着能不能通过cron自动下载安装, 于是就有了第一版本的<a href="(https://code.google.com/p/sharepythoncode/downloads/detail?name=Vandyke_update.py&amp;can=2&amp;q=)">Vandyke_update.py</a> 脚本,
通过抓包分析到Vandyke 的post数据,通过urllib2提交,并下载, 跑了一年都挺好的, </p>
<p>但是今天有同事(ubuntu)使用我的脚本自动更新的时候,发现无效了,返回信息提示”Bad product id”,
然后通过chrome的开发者工具跟踪了一下,发现post数据的字段改变了. 不再提供”sid”这个字段
(每次Vandyke用户登录之后都会在cookie中分配这个这个id,是不变的),只好重新分析它post内容,</p>
<p>看见它post内容变的非常简单,只有两个字段:</p>
<ol>
<li>pid(product id)</li>
<li>status</li>
</ol>
<p>尝试了几次,发现它现在所有认证信息都是从cookies里面获取的, 咱就只能模拟登录,
保留cookies,带着cookies访问它的下载页面</p>
<p>模拟登录,及带着cookies访问其他页面代码如下</p>
<div class="highlight"><pre><span class="n">import</span> <span class="n">urllib2</span><span class="p">,</span><span class="n">urllib</span>
<span class="n">import</span> <span class="n">cookielib</span>

<span class="n">cj</span> <span class="o">=</span> <span class="n">cookielib</span><span class="p">.</span><span class="n">CookieJar</span><span class="p">()</span>
<span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">urllib2</span><span class="p">.</span><span class="n">HTTPCookieProcessor</span><span class="p">(</span><span class="n">cj</span><span class="p">))</span>
<span class="n">urllib2</span><span class="p">.</span><span class="n">install_opener</span><span class="p">(</span><span class="n">opener</span><span class="p">)</span>

<span class="n">post</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="n">urlencode</span><span class="p">({</span><span class="err">&#39;</span><span class="n">pid</span><span class="sc">&#39;:&#39;</span><span class="n">securecrt_ubuntu1264_deb_71</span><span class="err">&#39;</span><span class="p">,</span>\
                          <span class="err">&#39;</span><span class="n">username</span><span class="sc">&#39;:&#39;</span><span class="n">eleven</span><span class="p">.</span><span class="n">i386</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span><span class="p">,</span>\
                          <span class="err">&#39;</span><span class="n">password</span><span class="sc">&#39;:&#39;</span><span class="o">*******</span><span class="err">&#39;</span><span class="p">,</span>\
                          <span class="err">&#39;</span><span class="n">status</span><span class="sc">&#39;:&#39;</span><span class="mi">4</span><span class="err">&#39;</span><span class="p">})</span>

<span class="n">post2</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="n">urlencode</span><span class="p">({</span><span class="err">&#39;</span><span class="n">pid</span><span class="sc">&#39;:&#39;</span><span class="n">securecrt_ubuntu1264_deb_71</span><span class="err">&#39;</span><span class="p">,</span>\
                          <span class="err">&#39;</span><span class="n">status</span><span class="sc">&#39;:&#39;</span><span class="n">self</span><span class="err">&#39;</span><span class="p">})</span>

<span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//secure.vandyke.com/cgi-bin/account_verify.php&#39;,post)</span>

<span class="n">req2</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//secure.vandyke.com/cgi-bin/download.php&#39;,post2)</span>
</pre></div>


<p>这是一段测试用的代码,请无视它那掉节操的变量名称,
实在不想花费脑细胞在测试代码的变量名称上(虽然正式代码的变量名称一样无节操)</p>
<h3>参数说明</h3>
<p>第一个post, 用于做登录. 提交用户名和密码,</p>
<p>第二个post,用于发送下载请求,提交请求资源的id,和status(这玩意一直不知道干嘛的),
请求资源的文件名称,在第一个post的respose header的Content-Disposition字段里面,</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>