<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Eleven.I386's Blog</title>
    <meta name="description" content="">
    <meta name="author" content="eleven.i386">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://eleveni386.7axu.com/theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="http://eleveni386.7axu.com/theme/bootstrap.min.css" rel="stylesheet">
    <link href="http://eleveni386.7axu.com/theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="http://eleveni386.7axu.com/theme/local.css" rel="stylesheet">
    <link href="http://eleveni386.7axu.com/theme/pygments.css" rel="stylesheet">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="http://eleveni386.7axu.com">Eleven.I386's Blog</a>

        <div class="nav-collapse">
        <ul class="nav">
            
        </ul>
        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
        

        


    <div class='article'>
        <div class="content-title">
            <a href="http://eleveni386.7axu.com/posts/2013/03/29/ji-ci-ddosgong-ji-dao-zhi-fu-wu-qi-si-ji/"><h1>记. 一次ddos攻击,导致服务器死机</h1></a>
五 29 三月 2013

by <a class="url fn" href="http://eleveni386.7axu.com/author/eleveni386.html">eleven.i386</a>
 


 
        </div>
        
        <div><h2>背景</h2>
<p>某年某月某天,eleven所属单位 被未知生物ddos攻击, 攻击时间 凌晨00:15 左右, 
eleven不在现场.其他同事处理的, 第二天eleven来到公司, 接到上面命令找出服务器弱点.
同时还原攻击现场,</p>
<h2>检查</h2>
<p>通过<strong>Zenoss</strong>监控图, 看见在00:15左右, 突然进来了大量的数据包, 大概40w左右, 
但是流量没有明显异常(即没有瞬间增高), 好吧, 看见这个现象就猜到了.. 小包<strong>DDos</strong>攻击.
通过服务器的message日志里面看见了<em>syn flood on 80</em> 记录,结合监控图上的大量数据包,
断定服务器被人采用<strong>syn半开攻击</strong>手法给攻击</p>
<h2>服务器配置</h2>
<p>观察了服务器的内核参数配置,因为我记得我们所有服务器都有对于<strong>syn flood</strong>的防御策略,
在sysctl.conf里面<strong>syn_cookies</strong>已经开启, 而且也看见syn队列增加到了1w6, 
按理来说单纯的半开攻击应该对于我们机器是无压力的说.</p>
<p>我们服务器是</p>
<p>Dell R210</p>
<p>Debian 6.0.7</p>
<p>2.6.32 kernel</p>
<p>网卡 Broadcom Corporation NetXtreme II BCM5716</p>
<p>网卡驱动 bnx2 版本2.0.2</p>
<h2>攻击模拟</h2>
<p>一开始自己用scapy写了一个syn攻击脚本,但是发包速度太慢了.于是想起了<strong>hping3</strong>,
这个东西,</p>
<p>挑选两台机器A君,B君, 对主机1.2.3.4发起syn攻击</p>
<p><code>hping3 -i u1 -S -p 80 1.2.3.4 –rand-source</code></p>
<p><style type="text/css">p.ex {color:rgb(0,0,255)}</style>
  <p>以上攻击命令,请勿随意尝试.</p></p>
<p>2秒之后, 1.2.34 挂了..&lt;(=－︿－=)&gt;</p>
<p>通过远程管理卡登录服务器发现,机器并没有死机, 只是网络不通了.机器无法ping通交换机,
交换机也无法ping通服务器, 重启服务器网卡, 恢复正常,判断网卡异常down掉. 找遍所有日志
kern.log, syslog.log, message.log, debug.log 都没有任何信息,仅有一条 syn flood on 80
和凌晨攻击的现象何其相似..</p>
<p>经过一下午的不断测试.确定了仅用一台机器就可以瞬间秒挂1.2.3.4这台服务器, 
奇怪.我们机器怎么就这么脆弱…</p>
<p>后来经过几次测试.排除了应用程序问题 替换nginx, lighttp, apache, 排除了交换机问题,
(白痴都想得到.交换机要是死了,我们所有业务就崩溃了),那么就剩下服务器自身的问题,
但是服务器没有死机.那么就只剩下服务器网卡..</p>
<p>经过一番搜索..发现google上也有同志发现了<em>宝兰网卡</em>异常down掉的情况. 看到这里,
我就找到一台Intel网卡的机器. 然后继续做ddos测试, 发现Intel网卡机器,虽然无法提供服务了..
系统被我拖的死死的.但是只要我停止攻击,系统就能很快的恢复. 而不会出现停止攻击了,
还无法登录服务器(网卡死掉). 可以肯定我们服务器这次浩劫的原因就是网卡的问题了..</p>
<h2>结语</h2>
<p>到dell官方下载最新的bnx2驱动. 更新驱动之后,继续测试.. 这时不断怎么攻击,
都无法将网卡打死. 只能造成业务无法正常访问而已.</p>
<p>没有做软中断的负载均衡.当攻击的时候网卡中断都集中在cpu0上,正常的数据包都被
攻击数据包给淹没了..自然无法提供服务.</p></div>
        <hr />
    </div>
		
<div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Previous</a></li>

    <li class="active"><a href="http://eleveni386.7axu.com/tag/ddos.html">1</a></li>

    <li class="next disabled"><a href="#">&rarr; Next</a></li>

</ul>
</div>
 
  
        </div>
        
        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Site
                </li>
            
                <li><a href="http://eleveni386.7axu.com/">Archives</a>
                <li><a href="http://eleveni386.7axu.com/tags.html">Tags</a>
                <li><a href="http://eleveni386.7axu.com/feeds/rss.xml" rel="alternate">Atom feed</a></li>
            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categories
                </li>
                
                <li><a href="http://eleveni386.7axu.com/category/jian-kong-xi-tong.html">监控系统</a></li>
                <li><a href="http://eleveni386.7axu.com/category/linuxyun-wei.html">Linux运维</a></li>
                <li><a href="http://eleveni386.7axu.com/category/linuxzhuo-mian.html">Linux桌面</a></li>
                <li><a href="http://eleveni386.7axu.com/category/mu-ma-bing-du.html">木马病毒</a></li>
                <li><a href="http://eleveni386.7axu.com/category/python.html">python</a></li>
                <li><a href="http://eleveni386.7axu.com/category/ruan-jian-tui-jian.html">软件推荐</a></li>
                <li><a href="http://eleveni386.7axu.com/category/vim.html">vim</a></li>
                   
            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Links
                </li>
            
                <li><a href="http://www.linuxzen.com/">cold</a></li>
                <li><a href="http://lilydjwg.is-programmer.com/">依云</a></li>
                <li><a href="https://www.7axu.com/">小柒'网络志</a></li>
                <li><a href="http://neteue.com/">小邪兽</a></li>
                <li><a href="http://supercat-lab.org/">老猫</a></li>
                <li><a href="http://blog.woodelf.org/">woodelf</a></li>
            </ul>
            </div>


            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Social
                </li>
           
                <li><a href="https://github.com/eleveni386">GitHub</a></li>
                <li><a href="https://plus.google.com/102949387282276761880">G+</a></li>
            </ul>
            </div>
            </div>

        </div>  
    </div>     </div> 
<footer>
<br />
<p><a href="http://eleveni386.7axu.com">Eleven.I386's Blog</a> &copy; eleven.i386 2012</p>
<script src="http://v1.cnzz.com/stat.php?id=4484286&web_id=4484286" language="JavaScript"></script>
</footer>

</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js"></script>
<a href="https://github.com/eleveni386"><img style="position: absolute; top: 40px; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub" /></a>
 
</body>
</html>