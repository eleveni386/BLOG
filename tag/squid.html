<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Eleven.I386's Blog</title>
    <meta name="description" content="">
    <meta name="author" content="eleven.i386">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://eleveni386.7axu.com/theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="http://eleveni386.7axu.com/feeds/rss.xml" type="application/atom+xml" rel="alternate" title="ElevenI386'blog Atom Feed" />
    <link href="http://eleveni386.7axu.com/theme/bootstrap.min.css" rel="stylesheet">
    <link href="http://eleveni386.7axu.com/theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="http://eleveni386.7axu.com/theme/local.css" rel="stylesheet">
    <link href="http://eleveni386.7axu.com/theme/pygments.css" rel="stylesheet">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="http://eleveni386.7axu.com">Eleven.I386's Blog</a>

        <div class="nav-collapse">
        <ul class="nav">
                    
                            <li><a href="http://eleveni386.7axu.com/pages/guan-yu-bo-zhu.html">关于博主</a></li>
                        </ul>
        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
                

        


    <div class='article'>
        <div class="content-title">
            <a href="http://eleveni386.7axu.com/posts/2014/03/07/squidzheng-xiang-dai-li/"><h1>squid正向代理</h1></a>
            五 07 三月 2014

by <a class="url fn" href="http://eleveni386.7axu.com/author/eleveni386.html">eleven.i386</a>
 


 
        </div>
        
        <div><h2>匿名代理</h2>
<p>squid 要做到匿名代理 只需要添加</p>
<div class="highlight"><pre><span class="n">header_access</span> <span class="n">Via</span> <span class="n">deny</span> <span class="n">all</span> 
<span class="n">header_access</span>  <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="n">deny</span> <span class="n">all</span>
</pre></div>


<p>即可</p>
<h2>代理验证</h2>
<p>谁都不想自己的代理服务器被他人随意拿来使用.. 于是 我们就需要给代理服务器加上密码</p>
<div class="highlight"><pre><span class="n">auth_param</span> <span class="n">basic</span> <span class="n">program</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">eleven</span><span class="o">/</span><span class="n">squid2</span><span class="p">.</span>7<span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ncsa_auth</span>
<span class="n">auth_param</span> <span class="n">basic</span> <span class="n">children</span> 1
<span class="n">auth_param</span> <span class="n">basic</span> <span class="n">realm</span> &quot;<span class="n">Welcome</span> <span class="n">to</span> <span class="n">eleven</span><span class="o">&#39;</span><span class="n">s</span> <span class="n">proxy</span> <span class="n">server</span>&quot;
<span class="n">auth_param</span> <span class="n">basic</span> <span class="n">credentialsttl</span> 12 <span class="n">hours</span>
</pre></div>


<p>这里的<strong>ncsa_auth</strong> 是自己写的shell脚本, 我的squid版本是2.7, 没有自带ncsa_auth程序</p>
<h2>一个简单的代理验证脚本</h2>
<div class="highlight"><pre><span class="k">while</span> <span class="n">true</span><span class="p">;</span>
<span class="n">do</span>
    <span class="n">read</span> <span class="n">line</span>
    <span class="n">username</span><span class="p">=</span>`<span class="n">echo</span> $<span class="n">line</span> <span class="o">|</span> <span class="n">awk</span> <span class="s">&#39;{print $1}&#39;</span>`<span class="p">;</span>
    <span class="n">password</span><span class="p">=</span>`<span class="n">echo</span> $<span class="n">line</span> <span class="o">|</span> <span class="n">awk</span> <span class="s">&#39;{print $2}&#39;</span>`<span class="p">;</span>

    <span class="k">if</span> <span class="p">[</span> &quot;<span class="n">x</span>$<span class="n">username</span>&quot; <span class="o">==</span> &quot;<span class="n">xeleven</span>&quot; <span class="p">]</span>
    <span class="n">then</span>
        <span class="k">if</span> <span class="p">[</span> &quot;<span class="n">x</span>$<span class="n">password</span>&quot; <span class="o">==</span> &quot;<span class="n">x</span><span class="o">*****</span>&quot; <span class="p">]</span>
        <span class="n">then</span>
            <span class="n">echo</span> <span class="n">OK</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">echo</span> <span class="n">Err</span><span class="p">;</span>
        <span class="n">fi</span>  
    <span class="k">else</span>
        <span class="n">echo</span> <span class="n">Err</span><span class="p">;</span>
    <span class="n">fi</span>  
<span class="n">done</span>
</pre></div>


<p>这个脚本有点类似之前的<a href="http://eleveni386.7axu.com/posts/2013/10/13/squid-url-tiao-zhuan/"><strong>squid url跳转</strong></a>
使用的脚本. 都是脚本从squid处接收需要处理的信息, 脚本处理完毕之后返回给squid结果</p>
<h2>squid正向代理, 搭建 http 代理服务器</h2>
<p>以下是一份完整的squid正向代理的配置文件</p>
<div class="highlight"><pre><span class="n">auth_param</span> <span class="n">basic</span> <span class="n">program</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">eleven</span><span class="o">/</span><span class="n">squid2</span><span class="p">.</span>7<span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ncsa_auth</span>
<span class="n">auth_param</span> <span class="n">basic</span> <span class="n">children</span> 1
<span class="n">auth_param</span> <span class="n">basic</span> <span class="n">realm</span> &quot;<span class="n">Welcome</span> <span class="n">to</span> <span class="n">eleven</span><span class="o">&#39;</span><span class="n">s</span> <span class="n">proxy</span> <span class="n">server</span>&quot;
<span class="n">auth_param</span> <span class="n">basic</span> <span class="n">credentialsttl</span> 12 <span class="n">hours</span>
<span class="n">acl</span> <span class="n">all</span> <span class="n">src</span> <span class="n">all</span> 
<span class="n">acl</span> <span class="n">squid_user</span> <span class="n">proxy_auth</span> <span class="n">REQUIRED</span>
<span class="n">acl</span> <span class="n">manager</span> <span class="n">proto</span> <span class="n">cache_object</span>
<span class="n">acl</span> <span class="n">localhost</span> <span class="n">src</span> 127<span class="p">.</span>0<span class="p">.</span>0<span class="p">.</span>1<span class="o">/</span>32
<span class="n">acl</span> <span class="n">SSL_ports</span> <span class="n">port</span> 443 
<span class="n">acl</span> <span class="n">Safe_ports</span> <span class="n">port</span> 80      # <span class="n">http</span>
<span class="n">acl</span> <span class="n">Safe_ports</span> <span class="n">port</span> 21      # <span class="n">ftp</span>
<span class="n">acl</span> <span class="n">Safe_ports</span> <span class="n">port</span> 443     # <span class="n">https</span>
<span class="n">acl</span> <span class="n">CONNECT</span> <span class="n">method</span> <span class="n">CONNECT</span>
<span class="n">http_access</span> <span class="n">allow</span> <span class="n">manager</span> <span class="n">localhost</span>
<span class="n">http_access</span> <span class="n">deny</span> <span class="n">manager</span>
<span class="n">http_access</span> <span class="n">deny</span> !<span class="n">Safe_ports</span>
<span class="n">http_access</span> <span class="n">deny</span> <span class="n">CONNECT</span> !<span class="n">SSL_ports</span>
<span class="n">http_access</span> <span class="n">allow</span> <span class="n">localhost</span>
# 允许密码用户登录
<span class="n">http_access</span> <span class="n">allow</span> <span class="n">squid_user</span>
# 拒绝其他所有请求
<span class="n">http_access</span> <span class="n">deny</span> <span class="n">all</span>
# <span class="n">Squid</span>的监听端口
<span class="n">http_port</span> <span class="o">****</span> # 不准暴力猜解我的密码<span class="p">.</span> 哼
# <span class="n">DNS</span> 域名服务器配置
<span class="n">dns_nameservers</span> 8<span class="p">.</span>8<span class="p">.</span>8<span class="p">.</span>8
# 启动<span class="n">squid2</span><span class="p">.</span>7的用户
<span class="n">cache_effective_user</span> <span class="n">eleven</span>
<span class="n">cache_effective_group</span> <span class="n">eleven</span>
# <span class="n">squid2</span><span class="p">.</span>7访问日志<span class="p">;</span> 调试时开启
#<span class="n">cache_access_log</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">squid</span><span class="o">/</span><span class="n">access</span><span class="p">.</span><span class="nb">log</span>
#<span class="n">cache_log</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">squid</span><span class="o">/</span><span class="n">cache</span><span class="p">.</span><span class="nb">log</span>
# <span class="n">squid2</span><span class="p">.</span>7挂掉后，<span class="n">core</span>文件位置
<span class="n">coredump_dir</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">eleven</span><span class="o">/</span><span class="n">squid2</span><span class="p">.</span>7<span class="o">/</span>
# 高匿
<span class="n">header_access</span> <span class="n">Via</span> <span class="n">deny</span> <span class="n">all</span>
<span class="n">header_access</span>  <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="n">deny</span> <span class="n">all</span>
# 出现<span class="n">cgi</span><span class="o">-</span><span class="n">bin</span>或者？的<span class="n">URL</span>不予缓存
<span class="n">hierarchy_stoplist</span> <span class="n">cgi</span><span class="o">-</span><span class="n">bin</span> ? <span class="o">\</span><span class="p">.</span><span class="n">php</span>
<span class="n">acl</span> <span class="n">QUERY</span> <span class="n">urlpath_regex</span> <span class="o">-</span><span class="nb">i</span> <span class="n">cgi</span><span class="o">-</span><span class="n">bin</span> <span class="p">[</span>^<span class="n">html</span><span class="p">]</span><span class="o">\</span>? <span class="o">\</span><span class="p">.</span><span class="n">asp</span> <span class="o">\</span><span class="p">.</span><span class="n">php</span> <span class="o">\</span><span class="p">.</span><span class="n">jsp</span> <span class="o">\</span><span class="p">.</span><span class="n">cgi</span>
<span class="n">acl</span> <span class="n">download</span> <span class="n">urlpath_regex</span> <span class="o">-</span><span class="nb">i</span> <span class="o">\</span><span class="p">.</span><span class="n">avi</span>$ <span class="o">\</span><span class="p">.</span><span class="n">rmvb</span>$ <span class="o">\</span><span class="p">.</span><span class="n">rm</span>$ <span class="o">\</span><span class="p">.</span><span class="n">ra</span>$ <span class="o">\</span><span class="p">.</span><span class="n">ram</span>$ <span class="o">\</span><span class="p">.</span><span class="n">mpe</span>$ <span class="o">\</span><span class="p">.</span><span class="n">smi</span>$
<span class="n">cache</span> <span class="n">deny</span> <span class="n">QUERY</span>
<span class="n">cache</span> <span class="n">deny</span> <span class="n">download</span>
# 磁盘缓存目录
<span class="n">cache_dir</span> <span class="n">ufs</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">eleven</span><span class="o">/</span><span class="n">squid2</span><span class="p">.</span>7<span class="o">/</span><span class="n">cdir</span> 500 16 256
# 内存缓冲大小
<span class="n">cache_mem</span> 2<span class="n">M</span>
# 刷新缓存规则
<span class="n">refresh_pattern</span> ^<span class="n">ftp</span><span class="p">:</span>       1440    20<span class="c">% 10080</span>
<span class="n">refresh_pattern</span> <span class="o">-</span><span class="nb">i</span> <span class="p">(</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/|\</span>?<span class="p">)</span> 0 0<span class="c">%  0</span>
<span class="n">refresh_pattern</span> <span class="p">.</span>       0   20<span class="c">% 4320</span>
</pre></div>


<h2>加密本地至squid的请求</h2>
<p>前面的文章里面讲解过了使用<strong>Stunnel</strong>做加密解密, 本地使用<strong>socat</strong>做数据转发, 采用
<strong>openssl</strong> 加密本地http数据,</p>
<p><a href="http://eleveni386.7axu.com/posts/2013/05/17/jia-mi-ni-de-httpqing-qiu-chuan-qiang/">参考文章</a></p>
<h2>结束</h2>
<p>至此, 一个全新的支持https访问的 http代理就搭建成功了. 第一次访问会要求你输入帐号和密码
相信看过本人此前的文章 都知道我曾经使用了一个叫做<strong>kangle</strong>的工具 搭建了一个http代理.
不知道从什么时候开始 <strong>kangle</strong> 搭建的代理 无法访问https协议的 站点. 于是,才迫使我
转而使用squid. </p></div>
        <hr />
    </div>
		
    
 
        

 

    <div class='article'>
        <a href="http://eleveni386.7axu.com/posts/2013/10/13/squid-url-tiao-zhuan/"><h2>Squid Url 跳转</h2></a>
        <div class= "well small"> 日 13 十月 2013

by <a class="url fn" href="http://eleveni386.7axu.com/author/eleveni386.html">eleven.i386</a>
 


 </div>
        <div class="summary"><h2>需求</h2>
<p>当Iphone/Ipad/Android 等访问 http://www.xxx.com 时跳转到 
http://www.xxx.com/mobile/xxx/mobile.html?ref=www.xxi.com/</p>
<h2>分析</h2>
<p>squid不自带 url重写/跳转 功能, 要实现这些功能需要借助 <strong>重定向器</strong> 来解决</p>
<p>通过<code>redirect_program</code> 指定一个重定向器 来处理url的重写/跳转</p>
<p><code>redirect_program</code> 可以用perl/php/python 甚至shell来编写</p>
<h2>思路</h2>
<p>使用squid的<code>redirect_program</code> 指令 ,指定一个重定向器处理url跳转</p>
<p>使用acl 匹配Iphone, Ipad, Android 平台 ...</p> <a class="btn btn-info xsmall" href="http://eleveni386.7axu.com/posts/2013/10/13/squid-url-tiao-zhuan/">read more</a></div>
    </div>	
				
            <div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Previous</a></li>

    <li class="active"><a href="http://eleveni386.7axu.com/tag/squid.html">1</a></li>

    <li class="next disabled"><a href="#">&rarr; Next</a></li>

</ul>
</div>    
 
  
        </div>
        
        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Site
                </li>
            
                <!--  <li><a href="http://eleveni386.7axu.com/">Archives</a> -->
                <li><a href="http://eleveni386.7axu.com/archives.html">Archives</a>
                <li><a href="http://eleveni386.7axu.com/tags.html">Tags</a>
                <li><a href="http://eleveni386.7axu.com/feeds/rss.xml" rel="alternate">Atom feed</a></li>
                            </ul>
            </div>


                        <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categories
                </li>
                
                                <li><a href="http://eleveni386.7axu.com/category/linuxzhuo-mian.html">Linux桌面</a></li>
                                <li><a href="http://eleveni386.7axu.com/category/linuxyun-wei.html">Linux运维</a></li>
                                <li><a href="http://eleveni386.7axu.com/category/python.html">python</a></li>
                                <li><a href="http://eleveni386.7axu.com/category/vim.html">vim</a></li>
                                <li><a href="http://eleveni386.7axu.com/category/mu-ma-bing-du.html">木马病毒</a></li>
                                <li><a href="http://eleveni386.7axu.com/category/jian-kong-xi-tong.html">监控系统</a></li>
                                <li><a href="http://eleveni386.7axu.com/category/ruan-jian-tui-jian.html">软件推荐</a></li>
                                   
            </ul>
            </div>
            

                        <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Links
                </li>
            
                            <li><a href="http://www.linuxzen.com/">cold</a></li>
                            <li><a href="http://lilydjwg.is-programmer.com/">依云</a></li>
                            <li><a href="https://www.7axu.com/">小柒'网络志</a></li>
                            <li><a href="http://neteue.com/">小邪兽</a></li>
                            <li><a href="http://blog.woodelf.org/">woodelf</a></li>
                        </ul>
            </div>
            

                        <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Social
                </li>
           
                                <li><a href="https://github.com/eleveni386">github</a></li>
                                <li><a href="https://plus.google.com/102949387282276761880/posts/p/pub">G+</a></li>
                            </ul>
            </div>
            </div>
            
        </div>  
    </div>     </div> 
<footer>
<br />
<p><a href="http://eleveni386.7axu.com">Eleven.I386's Blog</a> &copy; eleven.i386 2012</p>
<script src="http://v1.cnzz.com/stat.php?id=4484286&web_id=4484286" language="JavaScript"></script>
</footer>

</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js"></script>
<a href="https://github.com/eleveni386"><img style="position: absolute; top: 40px; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub" /></a>
 
</body>
</html>