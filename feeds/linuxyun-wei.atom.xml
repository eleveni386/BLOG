<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Eleven.I386's Blog</title><link href="http://eleveni386.7axu.com/" rel="alternate"></link><link href="http://eleveni386.7axu.com/feeds/linuxyun-wei.atom.xml" rel="self"></link><id>http://eleveni386.7axu.com/</id><updated>2014-02-27T00:00:00+08:00</updated><entry><title>记一次ssh密钥登录失败</title><link href="http://eleveni386.7axu.com/posts/2014/02/27/ji-ci-sshmi-yao-deng-lu-shi-bai/" rel="alternate"></link><updated>2014-02-27T00:00:00+08:00</updated><author><name>eleven.i386</name></author><id>tag:eleveni386.7axu.com,2014-02-27:posts/2014/02/27/ji-ci-sshmi-yao-deng-lu-shi-bai/</id><summary type="html">&lt;h2&gt;环境&lt;/h2&gt;
&lt;p&gt;我们的私钥是通过SecureCRT工具生成的. 在Debian5/6下面使用正常
有问题的主机是Debian7 系统, 客户端是Debian6 系统
Debian7 的ssh server版本是1.6 客户端的ssh client是1.5
使用的ssh协议均是2&lt;/p&gt;
&lt;h2&gt;现象&lt;/h2&gt;
&lt;p&gt;昨天我们一台Debian7主机, 无法通过私钥登录. 每次登录提示需要输入密码. 这是我们第一次使用Debian7的系统, 以往的主机都是Debian5/6的系统&lt;/p&gt;
&lt;p&gt;开启ssh的debug参数, 观看登录过程,发现如下&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;debug2&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;key_type_from_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;unknown&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt; &lt;span class="n"&gt;type&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;-----BEGIN&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;debug2&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;key_type_from_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;unknown&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt; &lt;span class="n"&gt;type&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;-----END&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;debug3&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;key_read&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;missing&lt;/span&gt; &lt;span class="n"&gt;whitespace&lt;/span&gt;
&lt;span class="n"&gt;debug3&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;key_read&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;missing&lt;/span&gt; &lt;span class="n"&gt;whitespace&lt;/span&gt;
&lt;span class="n"&gt;debug3&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;key_read&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;missing&lt;/span&gt; &lt;span class="n"&gt;whitespace&lt;/span&gt;
&lt;span class="o"&gt;......&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;排查&lt;/h2&gt;
&lt;p&gt;一开始看到这样的信息, 我以为是私钥格式不正确. 因为网络上一直流传着SecureCRT和Putty之类的工具,产生的密钥和ssh-keygen产生的 格式上有区别
不过从我们以往的经验上来看(Debian5/6) , SecureCRT生成的可以正常使用, &lt;/p&gt;
&lt;p&gt;虽然有这样的疑问 不过还是重新生成了一份密钥, 继续登录, 还是提示一样的问题, 我最后在Debian7 上 使用ssh-keygen生成一份密钥, 还是提示一样的问题
我突然醒悟过来, ssh兼容ssh1的协议. 于是ssh在登录的时候 会协商使用什么样的协议, 上面的提示问题应该是密钥格式不符合ssh1, 所以本次问题应该不是出
在私钥格式不对的问题, &lt;/p&gt;
&lt;p&gt;于是我去对比 ssh-keygen 产生的密钥 和 SecureCRT产生的有啥不同. 结果我发现 私钥里面写着root
我去.. 我的私钥是给cache用户用的, 私钥里面怎么会有root呢? &lt;/p&gt;
&lt;p&gt;小心翼翼的瞄了一眼 我的shell 提示符, &lt;strong&gt;#&lt;/strong&gt; 果果的出现了.... &lt;/p&gt;
&lt;p&gt;好吧, 为了排查方便我切换到了root下, 我却不记得了. &lt;/p&gt;
&lt;p&gt;切换到cache用户下 再次执行ssh-keygen &lt;/p&gt;
&lt;p&gt;在使用ssh-keygen的时候 有一个提示引起了我的注意 &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;    &lt;span class="n"&gt;open&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;home&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ssh&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;id_rsa&lt;/span&gt; &lt;span class="n"&gt;failed&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Permission&lt;/span&gt; &lt;span class="n"&gt;denied&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;为什么会Permission denied ? &lt;/p&gt;
&lt;p&gt;果断查看家目录下的 .ssh 目录权限.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;    &lt;span class="n"&gt;drw&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;--&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;--&lt;/span&gt; 2 &lt;span class="n"&gt;cache&lt;/span&gt; &lt;span class="n"&gt;cache&lt;/span&gt; 4096 &lt;span class="n"&gt;Feb&lt;/span&gt; 27 11&lt;span class="p"&gt;:&lt;/span&gt;03 &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ssh&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;我去, 说好的&lt;strong&gt;x&lt;/strong&gt;权限呢? &lt;/p&gt;
&lt;p&gt;给.ssh加上&lt;strong&gt;x&lt;/strong&gt;权限之后, 再次登录. 果断成功了... &lt;/p&gt;
&lt;h2&gt;结束&lt;/h2&gt;
&lt;p&gt;事后想想, 应该是用户在登录的时候, ssh要对用户提交的私钥做验证, 但是却无法进入.ssh目录, 就当作用户的公钥不存在, 于是要求用户使用密码方式&lt;/p&gt;</summary><category term="ssh"></category><category term="运维"></category><category term="密钥"></category><category term="Linux"></category></entry><entry><title>Squid Url 跳转</title><link href="http://eleveni386.7axu.com/posts/2013/10/13/squid-url-tiao-zhuan/" rel="alternate"></link><updated>2013-10-13T00:00:00+08:00</updated><author><name>eleven.i386</name></author><id>tag:eleveni386.7axu.com,2013-10-13:posts/2013/10/13/squid-url-tiao-zhuan/</id><summary type="html">&lt;h2&gt;需求&lt;/h2&gt;
&lt;p&gt;当Iphone/Ipad/Android 等访问 http://www.xxx.com 时跳转到 
http://www.xxx.com/mobile/xxx/mobile.html?ref=www.xxi.com/&lt;/p&gt;
&lt;h2&gt;分析&lt;/h2&gt;
&lt;p&gt;squid不自带 url重写/跳转 功能, 要实现这些功能需要借助 &lt;strong&gt;重定向器&lt;/strong&gt; 来解决&lt;/p&gt;
&lt;p&gt;通过&lt;code&gt;redirect_program&lt;/code&gt; 指定一个重定向器 来处理url的重写/跳转&lt;/p&gt;
&lt;p&gt;&lt;code&gt;redirect_program&lt;/code&gt; 可以用perl/php/python 甚至shell来编写&lt;/p&gt;
&lt;h2&gt;思路&lt;/h2&gt;
&lt;p&gt;使用squid的&lt;code&gt;redirect_program&lt;/code&gt; 指令 ,指定一个重定向器处理url跳转&lt;/p&gt;
&lt;p&gt;使用acl 匹配Iphone, Ipad, Android 平台&lt;/p&gt;
&lt;h2&gt;过程&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;tip&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;根据&lt;a href="http://home.arcor.de/pangj/squid/chap11.html#a1"&gt;squid权威手册&lt;/a&gt;
得知,重定向器从标准输出接收squid数据, 每一行包括以下4个元素:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;请求url&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;客户IP地址和完全可验证域名&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;用户名，通过RFC 1413 ident或代理验证&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;HTTP请求方式&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;exp: http://www.example.com/page1.html 192.168.2.3/- - GET&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;了解这个是非常重要的,本人就是因为一开始不知道这个,导致我的重定向器无法使用&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;然后, 重定向程序永不退出，除非在标准输入里发生end-of-file&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;这个也是很重要的,不然会导致重定向器的进程占用大量的cpu&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;最后, 重定向器返回空行, squid将不会对url做任何处理,该怎样还是怎样&lt;/p&gt;
&lt;h3&gt;产生一个重定向消息&lt;/h3&gt;
&lt;p&gt;网络上很多是基于perl的. 由于我不擅长那家伙, 于是我就用python写了一个例子.&lt;/p&gt;
&lt;table class="highlighttable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;#!/usr/bin/python&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;re&lt;/span&gt;

&lt;span class="n"&gt;URL_PATTERN&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;compile&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;(?P&amp;lt;scheme&amp;gt;https?://)(?P&amp;lt;host&amp;gt;[^/]*)(?P&amp;lt;request&amp;gt;.*)&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;GUIDE&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;compile&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;^/mobile/xxx/mobile\.html&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;redirect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;old_url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;()[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; 
    &lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;URL_PATTERN&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;old_url&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;scheme&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;group&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;scheme&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;hostname&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;group&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;host&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;group&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;request&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;GUIDE&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&lt;/span&gt;

    &lt;span class="n"&gt;new_url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;302:http://www.xxx.com/mobile/xxx/mobile.html?ref=&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;old_url&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;new_url&lt;/span&gt;

&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdin&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;readline&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;strip&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="k"&gt;break&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;redirect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;flush&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;Exception&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;将此脚本给予 执行权限&lt;code&gt;chmod +x mobile_redirect.py&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;然后在squid.conf中增加&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;acl&lt;/span&gt; &lt;span class="n"&gt;Debian&lt;/span&gt; &lt;span class="n"&gt;browser&lt;/span&gt; &lt;span class="n"&gt;Chrome&lt;/span&gt; 
&lt;span class="n"&gt;acl&lt;/span&gt; &lt;span class="n"&gt;Iphone&lt;/span&gt; &lt;span class="n"&gt;browser&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="nb"&gt;i&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;iPhone&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;iPad&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;acl&lt;/span&gt; &lt;span class="n"&gt;Android&lt;/span&gt; &lt;span class="n"&gt;browser&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="nb"&gt;i&lt;/span&gt; &lt;span class="n"&gt;Android&lt;/span&gt;
&lt;span class="n"&gt;redirect_program&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;squidpath&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;mobile_redirect&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt;
&lt;span class="n"&gt;redirect_children&lt;/span&gt; 6
&lt;span class="n"&gt;redirector_access&lt;/span&gt; &lt;span class="n"&gt;allow&lt;/span&gt; &lt;span class="n"&gt;Debian&lt;/span&gt;
&lt;span class="n"&gt;redirector_access&lt;/span&gt; &lt;span class="n"&gt;allow&lt;/span&gt; &lt;span class="n"&gt;Iphone&lt;/span&gt;
&lt;span class="n"&gt;redirector_access&lt;/span&gt; &lt;span class="n"&gt;allow&lt;/span&gt; &lt;span class="n"&gt;Android&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;重启squid之后, 观察结果&lt;/p&gt;
&lt;p&gt;客户端请求 www.xxx.com&lt;/p&gt;
&lt;p&gt;squid 日志中&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;1381544425&lt;span class="p"&gt;.&lt;/span&gt;298      0 14&lt;span class="p"&gt;.&lt;/span&gt;23&lt;span class="p"&gt;.&lt;/span&gt;156&lt;span class="p"&gt;.&lt;/span&gt;2 &lt;span class="n"&gt;TCP_MISS&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;302 522 &lt;span class="n"&gt;GET&lt;/span&gt; &lt;span class="n"&gt;http&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;www&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;mobile&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;
&lt;span class="n"&gt;xxx&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;mobile&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;html&lt;/span&gt;?&lt;span class="n"&gt;ref&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="n"&gt;http&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;www&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xxx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;NONE&lt;/span&gt;&lt;span class="o"&gt;/-&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;客户端返回&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;HTTP&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;1&lt;span class="p"&gt;.&lt;/span&gt;0 302 &lt;span class="n"&gt;Moved&lt;/span&gt; &lt;span class="n"&gt;Temporarily&lt;/span&gt;
&lt;span class="n"&gt;Server&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;squid&lt;/span&gt;
&lt;span class="n"&gt;Date&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Sat&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; 12 &lt;span class="n"&gt;Oct&lt;/span&gt; 2013 02&lt;span class="p"&gt;:&lt;/span&gt;19&lt;span class="p"&gt;:&lt;/span&gt;37 &lt;span class="n"&gt;GMT&lt;/span&gt;
&lt;span class="n"&gt;Content&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Length&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; 0
&lt;span class="n"&gt;Location&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;http&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;www&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;mobile&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;xxx&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;mobile&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;html&lt;/span&gt;?&lt;span class="n"&gt;ref&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="n"&gt;http&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;www&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xxx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;
&lt;span class="n"&gt;X&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Cache&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;MISS&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; 0&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cnc&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;
&lt;span class="n"&gt;X&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Cache&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Lookup&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;HIT&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; 0&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cnc&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;80
&lt;span class="n"&gt;Via&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; 1&lt;span class="p"&gt;.&lt;/span&gt;1 0&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cnc&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;80 &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;squid&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;Connection&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;close&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;squid 成功跳转&lt;/p&gt;
&lt;h2&gt;总结&lt;/h2&gt;
&lt;p&gt;在本人处理这个需求的时候, 不了解squid跳转的过程和注意点,因此走了很多弯路.浪费很多
时间, 处理完毕之后,突然发现 其实squid跳转非常简单. 只要了解以上&lt;strong&gt;tip&lt;/strong&gt;就好了&lt;/p&gt;
&lt;p&gt;&lt;a href="http://home.arcor.de/pangj/squid/chap11.html#a1"&gt;参考文档&lt;/a&gt;&lt;/p&gt;</summary><category term="运维"></category><category term="squid"></category></entry><entry><title>加密你的HTTP请求(穿墙)</title><link href="http://eleveni386.7axu.com/posts/2013/05/17/jia-mi-ni-de-httpqing-qiu-chuan-qiang/" rel="alternate"></link><updated>2013-05-17T00:00:00+08:00</updated><author><name>eleven.i386</name></author><id>tag:eleveni386.7axu.com,2013-05-17:posts/2013/05/17/jia-mi-ni-de-httpqing-qiu-chuan-qiang/</id><summary type="html">&lt;p&gt;之前用&lt;strong&gt;kangle&lt;/strong&gt;在香港的vps上做了一个http代理
  但是在使用的时候发现,访问国外的一些站点 还是无法正常访问,但是在vps上面访问正常,
而且kangle日志里面看见国外那些站点返回的状态码也是200,说明vps请求那些站点是没问题的
那么问题就是发生在客户端跟vps之间了,因为这一段的数据是明文的HTTP请求, 很容易被上层运营商过滤掉
那么我们就将客户端跟vps之间这段http过程加密就好了,&lt;/p&gt;
&lt;h2&gt;Stunnel&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Stunnel 是一种程序，使程序员和系统管理员可以很轻松地对任意 TCP 会话加密。
您可以很轻松地在客户机和服务器上启用 SSL ― 而且这样做不会影响程序源代码。
Stunnel 服务器主要执行两个功能：
一，首先，接收未加密的数据流，进行 SSL 加密，然后将其通过网络发送；
二，对已进行 SSL 加密的数据流进行解密，并将其通过网络发送给另一个程序
（该程序通常驻留在同一机器上，以避免本地网络上的窥探攻击）。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href="https://www.stunnel.org/downloads.html"&gt;下载地址&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;安装注意&lt;/h2&gt;
&lt;p&gt;在make install 的时候会要求你输入一些信息,用来生成证书, 按照提示输入即可&lt;/p&gt;
&lt;h2&gt;配置&lt;/h2&gt;
&lt;h3&gt;这里仅作为proxy&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;syslog&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;yes&lt;/span&gt;  #使用&lt;span class="n"&gt;syslog&lt;/span&gt;日志
&lt;span class="n"&gt;fips&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;no&lt;/span&gt;  #关闭&lt;span class="n"&gt;fips&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt; 如果你支持&lt;span class="n"&gt;fips&lt;/span&gt; 默认就好了&lt;span class="p"&gt;,&lt;/span&gt; 默认配置文件里面是没有这个的&lt;span class="p"&gt;,&lt;/span&gt; 如果在启动&lt;span class="n"&gt;stunnel&lt;/span&gt;服务的时候 提示&lt;span class="n"&gt;fips&lt;/span&gt; 不支持那么就关闭它
&lt;span class="n"&gt;cert&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;youtpath&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;stunnel&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;stunnel&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;stunnel&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pem&lt;/span&gt;
然后将

&lt;span class="p"&gt;;[&lt;/span&gt;&lt;span class="n"&gt;pop3s&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="n"&gt;accept&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; 995
&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="n"&gt;connect&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; 110

&lt;span class="p"&gt;;[&lt;/span&gt;&lt;span class="n"&gt;imaps&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="n"&gt;accept&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; 993
&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="n"&gt;connect&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; 143

&lt;span class="p"&gt;;[&lt;/span&gt;&lt;span class="n"&gt;ssmtp&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="n"&gt;accept&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; 465
&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="n"&gt;connect&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; 25
注释掉&lt;span class="p"&gt;,&lt;/span&gt; 注释符号 &lt;span class="p"&gt;;&lt;/span&gt;

新增加
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;proxy&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;accept&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; 8081
&lt;span class="n"&gt;connect&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; 8082
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;现在&lt;strong&gt;Stunnel&lt;/strong&gt;已经配置好了, 监听8081端口, 转发到8082(kangle)&lt;/p&gt;
&lt;p&gt;服务端已经配置好, 接下来该客户端了&lt;/p&gt;
&lt;p&gt;在客户端上, 使用&lt;strong&gt;socat&lt;/strong&gt;工具, 也可以使用stunnel, 
不过proxy那里的connect就要写上远程主机的地址和端口, 为了简便,懒得去编译,就用socat&lt;/p&gt;
&lt;p&gt;如果的debian/ubuntu 用户直接apt-get 就可以安装
  &lt;code&gt;apt-get install socat&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;socat tcp-listen:8082,fork openssl:tunnel-server:8081,verify=0&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;此处偷了&lt;a href="http://lilydjwg.is-programmer.com/2012/10/25/secure-your-http-proxy-with-tls-ssl.36107.html"&gt;依云&lt;/a&gt;
的例子 :-)&lt;/p&gt;
&lt;h2&gt;结语&lt;/h2&gt;
&lt;p&gt;socat 将监听本地8082,然后加密tcp数据转发至tunnel主机的8081端口,
这样本地的http请求就被加密了, 上层运营商无法过滤你http请求了.可以畅快的访问各个站点&lt;/p&gt;
&lt;p&gt;我自己为了方便, 将上面的命令写到开机启动里面, 
这样每次开机就自动监听了本地的8082端口,我需要使用代理的时候 只要在浏览器上面切换就好了,&lt;/p&gt;
&lt;p&gt;我的浏览器是google-chrome 用的代理工具是SwitchySharp&lt;/p&gt;</summary><category term="代理"></category><category term="安全"></category><category term="翻墙"></category><category term="http"></category></entry><entry><title>Kangle 做HTTP匿名代理</title><link href="http://eleveni386.7axu.com/posts/2013/05/17/kangle-zuo-httpni-ming-dai-li/" rel="alternate"></link><updated>2013-05-17T00:00:00+08:00</updated><author><name>eleven.i386</name></author><id>tag:eleveni386.7axu.com,2013-05-17:posts/2013/05/17/kangle-zuo-httpni-ming-dai-li/</id><summary type="html">&lt;blockquote&gt;
&lt;p&gt;kangle web服务器（简称：kangle）是一款跨平台、功能强大、安全稳定、
易操作的高性能web服务器和反向代理服务器软件。除此：kangle也是一款专为做虚拟主机
研发的web服务器。实现虚拟主机独立进程、独立身份运行。用户之间安全隔离，一个用户
出问题不影响其他用户。安全支持php、asp、asp·net、java、ruby等多种动态开发语言。
                                                        百度百科&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;安装&lt;/h2&gt;
&lt;p&gt;下载源码
  &lt;code&gt;wget http://www.kanglesoft.com/download/src/kangle-3.2.3.tar.gz&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;编译环境&lt;/p&gt;
&lt;p&gt;&lt;code&gt;apt-get install build-essential&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;安装pcre库&lt;/p&gt;
&lt;p&gt;&lt;code&gt;apt-get install libpcre++-dev&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;安装ssl库&lt;/p&gt;
&lt;p&gt;&lt;code&gt;apt-get install libssl-dev&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;编译&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="o"&gt;./&lt;/span&gt;&lt;span class="n"&gt;configure&lt;/span&gt; –&lt;span class="n"&gt;prefix&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="o"&gt;./&lt;/span&gt;&lt;span class="n"&gt;kangel&lt;/span&gt;
&lt;span class="n"&gt;make&lt;/span&gt; 
&lt;span class="n"&gt;make&lt;/span&gt; &lt;span class="n"&gt;install&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;配置&lt;/h2&gt;
&lt;p&gt;安装完之后,在./kangle/etc/下有一个config.xml 文件&lt;/p&gt;
&lt;p&gt;可以在这里修改 &lt;em&gt;http监听端口&lt;/em&gt; 和&lt;em&gt;web管理端口&lt;/em&gt;, 以及其他的选项,
当然也可以直接启动kangle然后通过web管理界面进行选项修改&lt;/p&gt;
&lt;p&gt;设置匿名代理&lt;/p&gt;
&lt;p&gt;在web控制台–请求控制–插入一条新的规则&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="/image/1368197336.png" /&gt;&lt;/p&gt;
&lt;p&gt;在&lt;strong&gt;可用的标记模块&lt;/strong&gt;中选择&lt;strong&gt;flag&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="/image/1368197369.png" /&gt;&lt;/p&gt;
&lt;p&gt;然后勾选&lt;strong&gt;no_x_forared_for&lt;/strong&gt;,点击提交&lt;/p&gt;
&lt;h2&gt;结语&lt;/h2&gt;
&lt;p&gt;设置本机浏览器的代理地址为kangle地址之后
访问www.ip138.com会发现客户端的ip变成了代理服务器的ip, 实现了匿名访问&lt;/p&gt;
&lt;p&gt;其实做这种正向代理, 用&lt;strong&gt;nginx&lt;/strong&gt; 也是完全可以的.没必要用这种不是很信任的软件&lt;/p&gt;</summary><category term="代理"></category><category term="翻墙"></category></entry><entry><title>网卡中断绑定</title><link href="http://eleveni386.7axu.com/posts/2013/04/25/wang-qia-zhong-duan-bang-ding/" rel="alternate"></link><updated>2013-04-25T00:00:00+08:00</updated><author><name>eleven.i386</name></author><id>tag:eleveni386.7axu.com,2013-04-25:posts/2013/04/25/wang-qia-zhong-duan-bang-ding/</id><summary type="html">&lt;blockquote&gt;
&lt;p&gt;中断亲和力是指将一个或多个中断源绑定到特定的 CPU 上运行&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;操作&lt;/h2&gt;
&lt;p&gt;&lt;a href="http://liuxin1982.blog.51cto.com/4338970/1019825"&gt;参考&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今天我是来吐槽该文中的一个shell脚本&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# setting up irq affinity according to /proc/interrupts&lt;/span&gt;
&lt;span class="c"&gt;# 2008-11-25 Robert Olsson&lt;/span&gt;
&lt;span class="c"&gt;# 2009-02-19 updated by Jesse Brandeburg&lt;/span&gt;
&lt;span class="c"&gt;#&lt;/span&gt;
&lt;span class="c"&gt;# &amp;gt; Dave Miller:&lt;/span&gt;
&lt;span class="c"&gt;# (To get consistent naming in /proc/interrups)&lt;/span&gt;
&lt;span class="c"&gt;# I would suggest that people use something like:&lt;/span&gt;
&lt;span class="c"&gt;# char buf[IFNAMSIZ+6];&lt;/span&gt;
&lt;span class="c"&gt;#&lt;/span&gt;
&lt;span class="c"&gt;# sprintf(buf, &amp;quot;%s-%s-%d&amp;quot;,&lt;/span&gt;
&lt;span class="c"&gt;#         netdev-&amp;gt;name,&lt;/span&gt;
&lt;span class="c"&gt;#  (RX_INTERRUPT ? &amp;quot;rx&amp;quot; : &amp;quot;tx&amp;quot;),&lt;/span&gt;
&lt;span class="c"&gt;#  queue-&amp;gt;index);&lt;/span&gt;
&lt;span class="c"&gt;#&lt;/span&gt;
&lt;span class="c"&gt;#  Assuming a device with two RX and TX queues.&lt;/span&gt;
&lt;span class="c"&gt;#  This script will assign: &lt;/span&gt;
&lt;span class="c"&gt;#&lt;/span&gt;
&lt;span class="c"&gt;# eth0-rx-0  CPU0&lt;/span&gt;
&lt;span class="c"&gt;# eth0-rx-1  CPU1&lt;/span&gt;
&lt;span class="c"&gt;# eth0-tx-0  CPU0&lt;/span&gt;
&lt;span class="c"&gt;# eth0-tx-1  CPU1&lt;/span&gt;
&lt;span class="c"&gt;#&lt;/span&gt;
&lt;span class="n"&gt;set_affinity&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;MASK&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;$&lt;span class="p"&gt;((&lt;/span&gt;1&lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt;$&lt;span class="n"&gt;VEC&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;%s mask=%X for /proc/irq/%d/smp_affinity\n&amp;quot;&lt;/span&gt; $&lt;span class="n"&gt;DEV&lt;/span&gt; $&lt;span class="n"&gt;MASK&lt;/span&gt; $&lt;span class="n"&gt;IRQ&lt;/span&gt;
    &lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;%X&amp;quot;&lt;/span&gt; $&lt;span class="n"&gt;MASK&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;proc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;irq&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;$&lt;span class="n"&gt;IRQ&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;smp_affinity&lt;/span&gt;
    &lt;span class="c"&gt;#echo $DEV mask=$MASK for /proc/irq/$IRQ/smp_affinity&lt;/span&gt;
    &lt;span class="c"&gt;#echo $MASK &amp;gt; /proc/irq/$IRQ/smp_affinity&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;$1&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;then&lt;/span&gt;
&lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Description:&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;    This script attempts to bind each queue of a multi-queue NIC&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;    to the same numbered core, ie tx0¦rx0 --&amp;gt; cpu0, tx1¦rx1 --&amp;gt; cpu1&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;usage:&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;    $0 eth0 [eth1 eth2 eth3]&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;fi&lt;/span&gt;

&lt;span class="c"&gt;# check for irqbalance running&lt;/span&gt;
&lt;span class="n"&gt;IRQBALANCE_ON&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;`&lt;span class="n"&gt;ps&lt;/span&gt; &lt;span class="n"&gt;ax&lt;/span&gt; ¦ &lt;span class="n"&gt;grep&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;v&lt;/span&gt; &lt;span class="n"&gt;grep&lt;/span&gt; ¦ &lt;span class="n"&gt;grep&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;q&lt;/span&gt; &lt;span class="n"&gt;irqbalance&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;echo&lt;/span&gt; $?`
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;$IRQBALANCE_ON&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;0&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;then&lt;/span&gt;
&lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s"&gt;&amp;quot; WARNING: irqbalance is running and will&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;          likely override this script&amp;#39;s affinitization.&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;          Please stop the irqbalance service and/or execute&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;          &amp;#39;killall irqbalance&amp;#39;&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;fi&lt;/span&gt;
&lt;span class="c"&gt;#&lt;/span&gt;
&lt;span class="c"&gt;# Set up the desired devices.&lt;/span&gt;
&lt;span class="c"&gt;#&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;DEV&lt;/span&gt; &lt;span class="n"&gt;in&lt;/span&gt; $&lt;span class="o"&gt;*&lt;/span&gt;
&lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;DIR&lt;/span&gt; &lt;span class="n"&gt;in&lt;/span&gt; &lt;span class="n"&gt;rx&lt;/span&gt; &lt;span class="n"&gt;tx&lt;/span&gt; &lt;span class="n"&gt;TxRx&lt;/span&gt;
&lt;span class="k"&gt;do&lt;/span&gt;
    &lt;span class="n"&gt;MAX&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;`&lt;span class="n"&gt;grep&lt;/span&gt; $&lt;span class="n"&gt;DEV&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;$&lt;span class="n"&gt;DIR&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;proc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;interrupts&lt;/span&gt; ¦ &lt;span class="n"&gt;wc&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;l&lt;/span&gt;`
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;$MAX&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;0&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;then&lt;/span&gt;
    &lt;span class="n"&gt;MAX&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;`&lt;span class="n"&gt;egrep&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;$DEV:.*$DIR&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;proc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;interrupts&lt;/span&gt; ¦ &lt;span class="n"&gt;wc&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;l&lt;/span&gt;`
    &lt;span class="n"&gt;fi&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;$MAX&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;0&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;then&lt;/span&gt;
    &lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="n"&gt;no&lt;/span&gt; $&lt;span class="n"&gt;DIR&lt;/span&gt; &lt;span class="n"&gt;vectors&lt;/span&gt; &lt;span class="n"&gt;found&lt;/span&gt; &lt;span class="n"&gt;on&lt;/span&gt; $&lt;span class="n"&gt;DEV&lt;/span&gt;
    &lt;span class="k"&gt;continue&lt;/span&gt;
    &lt;span class="c"&gt;#exit 1&lt;/span&gt;
    &lt;span class="n"&gt;fi&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;VEC&lt;/span&gt; &lt;span class="n"&gt;in&lt;/span&gt; `&lt;span class="n"&gt;seq&lt;/span&gt; 0 1 $&lt;span class="n"&gt;MAX&lt;/span&gt;`
     &lt;span class="k"&gt;do&lt;/span&gt;
        &lt;span class="n"&gt;IRQ&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;`&lt;span class="nb"&gt;cat&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;proc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;interrupts&lt;/span&gt; ¦ &lt;span class="n"&gt;grep&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt; $&lt;span class="n"&gt;DEV&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;$&lt;span class="n"&gt;DIR&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;$&lt;span class="n"&gt;VEC&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;$&amp;quot;&lt;/span&gt;  ¦ &lt;span class="nb"&gt;cut&lt;/span&gt;  &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;  &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;f1&lt;/span&gt; ¦ &lt;span class="n"&gt;sed&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;s/ //g&amp;quot;&lt;/span&gt;`
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;$IRQ&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;];&lt;/span&gt; &lt;span class="n"&gt;then&lt;/span&gt;
        &lt;span class="n"&gt;set_affinity&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;
        &lt;span class="n"&gt;IRQ&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;`&lt;span class="nb"&gt;cat&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;proc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;interrupts&lt;/span&gt; ¦ &lt;span class="n"&gt;egrep&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt; $&lt;span class="n"&gt;DEV&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;v&lt;/span&gt;$&lt;span class="n"&gt;VEC&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;$&lt;span class="n"&gt;DIR&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;$&amp;quot;&lt;/span&gt;  ¦ &lt;span class="nb"&gt;cut&lt;/span&gt;  &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;  &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;f1&lt;/span&gt; ¦ &lt;span class="n"&gt;sed&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;s/ //g&amp;quot;&lt;/span&gt;`
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;$IRQ&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;];&lt;/span&gt; &lt;span class="n"&gt;then&lt;/span&gt;
            &lt;span class="n"&gt;set_affinity&lt;/span&gt;
        &lt;span class="n"&gt;fi&lt;/span&gt;
        &lt;span class="n"&gt;fi&lt;/span&gt;
    &lt;span class="n"&gt;done&lt;/span&gt;
&lt;span class="n"&gt;done&lt;/span&gt;
&lt;span class="n"&gt;done&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;strong&gt;linux network子系统的负责人David Miller提供了一个脚本&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这个脚本一眼看上去 很正常的说, 可素对于现代服务器而言,其中隐含了一个很大的坑,
本人今天就亲身被坑了.&lt;/p&gt;
&lt;p&gt;看这段代码&lt;code&gt;MASK=$((1&amp;lt;&amp;lt;$VEC))&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;这里是计算cpu掩码的, 比如网卡eth0 第一个队列eth0-0 那么这里的结果就是MASK=1
将0左移一位 得到2进制0b10 十进制1&lt;/p&gt;
&lt;p&gt;这样看是很正常.. 因为根据网络上大片的文章显示计算cpu掩码,就是第几个网卡队列
就位移几位, 比如一个4核4队列网卡, 第4队列的cpu掩码为 &lt;code&gt;1&amp;lt;&amp;lt;3&lt;/code&gt; 等于&lt;strong&gt;8&lt;/strong&gt; 
反推回去可以得到前面三个队列的cpu掩码, 然后将这个cpu掩码分别写入每个队列中断号
的&lt;strong&gt;smp_affinity&lt;/strong&gt;.类似这样:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;echo $((1&amp;lt;&amp;lt;3)) &amp;gt; /proc/irq/xx/smp_affinity&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;这样就将xx中断绑定到第4个cpu上&lt;/p&gt;
&lt;p&gt;这样看还是很符合规律的,但是假设我们的cpu是8核, 网卡队列也是8个呢..&lt;/p&gt;
&lt;p&gt;根据&lt;code&gt;$((1&amp;lt;&amp;lt;7))&lt;/code&gt;得到的cpu掩码将是&lt;strong&gt;128&lt;/strong&gt; ,然后将128写入xx中断的smp_affinity中,
观察发现:尼玛说好的绑定到第8个cpu上的呢.. 怎么跑到第4个cpu上了?&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="mi"&gt;33&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;73905753&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="n"&gt;IR&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;PCI&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;MSI&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;edge&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;
&lt;span class="mi"&gt;34&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;5596608&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="n"&gt;IR&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;PCI&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;MSI&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;edge&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;
&lt;span class="mi"&gt;35&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;5590023&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="n"&gt;IR&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;PCI&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;MSI&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;edge&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;6&lt;/span&gt;
&lt;span class="mi"&gt;36&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;5574803&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="n"&gt;IR&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;PCI&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;MSI&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;edge&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;然后我又放狗..找到这么一句话
&lt;strong&gt;计算cpu的方法第一颗为00000001换算成16进制为1，第2颗cpu为00000010换算成16进制为2，依次类推得出，第8颗cpu为80&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这里有一个重点就是&lt;strong&gt;将2进制转换成16进制&lt;/strong&gt; 看到这里再看上面的脚本,
尼玛这不是坑爹么… &lt;code&gt;$((1&amp;lt;&amp;lt;n))&lt;/code&gt; 直接是将2进制给转成10进制了哇.. 假如n = 0-3的话,
还好. 结果还是正确的,但是一旦超过了3结果就开始偏差了..这样就直接导致我8核cpu8队
列网卡,在绑定中断的时候产生重叠…. 即队列0-3绑定到cpu0-3,队列4-7绑定到cpu0-3.. 坑爹呢….&lt;/p&gt;
&lt;p&gt;找到问题原因了, 于是就自己重写了一遍,&lt;/p&gt;
&lt;table class="highlighttable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;#!/usr/bin/python&lt;/span&gt;
&lt;span class="c"&gt;#coding=utf8&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="nn"&gt;re&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;irq&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="c"&gt;#return irq number and network interface number&lt;/span&gt;
    &lt;span class="c"&gt;#exp:&lt;/span&gt;
    &lt;span class="c"&gt;#irq iface&lt;/span&gt;
    &lt;span class="c"&gt;#61  0&lt;/span&gt;
    &lt;span class="c"&gt;#62  1&lt;/span&gt;
    &lt;span class="n"&gt;cpunum&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;popen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;cat /proc/cpuinfo¦grep &lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;model name&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;¦wc -l&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;popen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;cat /proc/interrupts ¦grep -E &lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;eth[0-9]-&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;¦awk &amp;#39;{sub(&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;eth[0-9]-&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;,&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;,$&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;);print $1,$&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;}&amp;#39;&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cpunum&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cpunum&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;readlines&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;()[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;:&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sub&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;[a-zA-Z]&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;()[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]))&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="p"&gt;]&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;irq_queuenum&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="c"&gt;# if exists irqbalance process,will killed&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;irqbalance&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;popen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;ps axu¦grep irqbalance¦grep -v grep¦wc -l&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;irqbalance&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;popen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;pkill irqbalance&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;irqbalance is kill&amp;quot;&lt;/span&gt;

    &lt;span class="c"&gt;# set irq_affinity&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;irq_queuenum&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;set_irq_affinity&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="nb"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;set_irq_affinity&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;IRQ&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;MASK&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;echo &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt; to /proc/irq/&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;/smp_affinity&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MASK&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;IRQ&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;fp&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;/proc/irq/&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;/smp_affinity&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;IRQ&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;w&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;fp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MASK&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;fp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;main&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;irq&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;h2&gt;结语&lt;/h2&gt;
&lt;p&gt;之所以研究中断亲和力,主要是为了增加网卡的负载能力,减少被大量小包攻击致死的几率.
将网卡的队列中断分别绑定到不同的&lt;strong&gt;Cpu Core&lt;/strong&gt;上,可以有效的提高小包负载能力,
由于之前我们前端服务器被小包攻击致死,因此这也是算我们的一种防御措施吧,&lt;/p&gt;
&lt;p&gt;附 参考资料:&lt;/p&gt;
&lt;p&gt;&lt;a href="http://blog.netzhou.net/?p=181"&gt;http://blog.netzhou.net/?p=181&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="http://www.ibm.com/developerworks/cn/linux/l-cn-linuxkernelint/"&gt;http://www.ibm.com/developerworks/cn/linux/l-cn-linuxkernelint/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="http://www.igigo.net/archives/231"&gt;http://www.igigo.net/archives/231&lt;/a&gt;&lt;/p&gt;</summary><category term="脚本"></category><category term="运维"></category></entry><entry><title>记. 一次ddos攻击,导致服务器死机</title><link href="http://eleveni386.7axu.com/posts/2013/03/29/ji-ci-ddosgong-ji-dao-zhi-fu-wu-qi-si-ji/" rel="alternate"></link><updated>2013-03-29T00:00:00+08:00</updated><author><name>eleven.i386</name></author><id>tag:eleveni386.7axu.com,2013-03-29:posts/2013/03/29/ji-ci-ddosgong-ji-dao-zhi-fu-wu-qi-si-ji/</id><summary type="html">&lt;h2&gt;背景&lt;/h2&gt;
&lt;p&gt;某年某月某天,eleven所属单位 被未知生物ddos攻击, 攻击时间 凌晨00:15 左右, 
eleven不在现场.其他同事处理的, 第二天eleven来到公司, 接到上面命令找出服务器弱点.
同时还原攻击现场,&lt;/p&gt;
&lt;h2&gt;检查&lt;/h2&gt;
&lt;p&gt;通过&lt;strong&gt;Zenoss&lt;/strong&gt;监控图, 看见在00:15左右, 突然进来了大量的数据包, 大概40w左右, 
但是流量没有明显异常(即没有瞬间增高), 好吧, 看见这个现象就猜到了.. 小包&lt;strong&gt;DDos&lt;/strong&gt;攻击.
通过服务器的message日志里面看见了&lt;em&gt;syn flood on 80&lt;/em&gt; 记录,结合监控图上的大量数据包,
断定服务器被人采用&lt;strong&gt;syn半开攻击&lt;/strong&gt;手法给攻击&lt;/p&gt;
&lt;h2&gt;服务器配置&lt;/h2&gt;
&lt;p&gt;观察了服务器的内核参数配置,因为我记得我们所有服务器都有对于&lt;strong&gt;syn flood&lt;/strong&gt;的防御策略,
在sysctl.conf里面&lt;strong&gt;syn_cookies&lt;/strong&gt;已经开启, 而且也看见syn队列增加到了1w6, 
按理来说单纯的半开攻击应该对于我们机器是无压力的说.&lt;/p&gt;
&lt;p&gt;我们服务器是&lt;/p&gt;
&lt;p&gt;Dell R210&lt;/p&gt;
&lt;p&gt;Debian 6.0.7&lt;/p&gt;
&lt;p&gt;2.6.32 kernel&lt;/p&gt;
&lt;p&gt;网卡 Broadcom Corporation NetXtreme II BCM5716&lt;/p&gt;
&lt;p&gt;网卡驱动 bnx2 版本2.0.2&lt;/p&gt;
&lt;h2&gt;攻击模拟&lt;/h2&gt;
&lt;p&gt;一开始自己用scapy写了一个syn攻击脚本,但是发包速度太慢了.于是想起了&lt;strong&gt;hping3&lt;/strong&gt;,
这个东西,&lt;/p&gt;
&lt;p&gt;挑选两台机器A君,B君, 对主机1.2.3.4发起syn攻击&lt;/p&gt;
&lt;p&gt;&lt;code&gt;hping3 -i u1 -S -p 80 1.2.3.4 –rand-source&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;style type="text/css"&gt;p.ex {color:rgb(0,0,255)}&lt;/style&gt;
  &lt;p&gt;以上攻击命令,请勿随意尝试.&lt;/p&gt;&lt;/p&gt;
&lt;p&gt;2秒之后, 1.2.34 挂了..&amp;lt;(=－︿－=)&amp;gt;&lt;/p&gt;
&lt;p&gt;通过远程管理卡登录服务器发现,机器并没有死机, 只是网络不通了.机器无法ping通交换机,
交换机也无法ping通服务器, 重启服务器网卡, 恢复正常,判断网卡异常down掉. 找遍所有日志
kern.log, syslog.log, message.log, debug.log 都没有任何信息,仅有一条 syn flood on 80
和凌晨攻击的现象何其相似..&lt;/p&gt;
&lt;p&gt;经过一下午的不断测试.确定了仅用一台机器就可以瞬间秒挂1.2.3.4这台服务器, 
奇怪.我们机器怎么就这么脆弱…&lt;/p&gt;
&lt;p&gt;后来经过几次测试.排除了应用程序问题 替换nginx, lighttp, apache, 排除了交换机问题,
(白痴都想得到.交换机要是死了,我们所有业务就崩溃了),那么就剩下服务器自身的问题,
但是服务器没有死机.那么就只剩下服务器网卡..&lt;/p&gt;
&lt;p&gt;经过一番搜索..发现google上也有同志发现了&lt;em&gt;宝兰网卡&lt;/em&gt;异常down掉的情况. 看到这里,
我就找到一台Intel网卡的机器. 然后继续做ddos测试, 发现Intel网卡机器,虽然无法提供服务了..
系统被我拖的死死的.但是只要我停止攻击,系统就能很快的恢复. 而不会出现停止攻击了,
还无法登录服务器(网卡死掉). 可以肯定我们服务器这次浩劫的原因就是网卡的问题了..&lt;/p&gt;
&lt;h2&gt;结语&lt;/h2&gt;
&lt;p&gt;到dell官方下载最新的bnx2驱动. 更新驱动之后,继续测试.. 这时不断怎么攻击,
都无法将网卡打死. 只能造成业务无法正常访问而已.&lt;/p&gt;
&lt;p&gt;没有做软中断的负载均衡.当攻击的时候网卡中断都集中在cpu0上,正常的数据包都被
攻击数据包给淹没了..自然无法提供服务.&lt;/p&gt;</summary><category term="安全"></category><category term="运维"></category><category term="ddos"></category></entry><entry><title>nginx 双机热备-实战</title><link href="http://eleveni386.7axu.com/posts/2012/10/18/nginx-shuang-ji-re-bei-shi-zhan/" rel="alternate"></link><updated>2012-10-18T00:00:00+08:00</updated><author><name>eleven.i386</name></author><id>tag:eleveni386.7axu.com,2012-10-18:posts/2012/10/18/nginx-shuang-ji-re-bei-shi-zhan/</id><summary type="html">&lt;p&gt;上次发布了&lt;em&gt;nginx&lt;/em&gt;做负载均衡器使用, 这次在原有的基础上加上了 &lt;strong&gt;双机热备&lt;/strong&gt;
另外,此篇文章做为引子,为的是引导使用&lt;strong&gt;keepalived&lt;/strong&gt;文中的配置,请酌情修改
这只是一个简单的&lt;strong&gt;keepalived&lt;/strong&gt;应用, 关于文中使用到的&lt;strong&gt;keepalived&lt;/strong&gt;参数很少, 
更多的内容看blog中的keepalived配置文件详解 那篇文章&lt;/p&gt;
&lt;p&gt;首先上一个 &lt;strong&gt;nginx高可用&lt;/strong&gt; 架构图&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="/image/2012-10-18-163233-300x225.png" /&gt;&lt;/p&gt;
&lt;h2&gt;配置&lt;/h2&gt;
&lt;p&gt;总共两台机器 A , B&lt;/p&gt;
&lt;p&gt;在A,B机器上面 配置好 nginx调度器, 相同的配置.&lt;/p&gt;
&lt;p&gt;A nginx 跑在 eth0 192.168.2.12 上&lt;/p&gt;
&lt;p&gt;B nginx 跑在 eth0 192.168.2.11 上&lt;/p&gt;
&lt;p&gt;在A,B机器上面 配置好 varnish, 相同配置.&lt;/p&gt;
&lt;p&gt;A varnish 跑在eth1 192.168.1.12 的8080端口上&lt;/p&gt;
&lt;p&gt;B varnish 跑在eth1 192.168.1.11 的8080端口上&lt;/p&gt;
&lt;p&gt;nginx的配置.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;upstream&lt;/span&gt; &lt;span class="n"&gt;backend&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="n"&gt;server&lt;/span&gt; 192&lt;span class="p"&gt;.&lt;/span&gt;168&lt;span class="p"&gt;.&lt;/span&gt;1&lt;span class="p"&gt;.&lt;/span&gt;12&lt;span class="p"&gt;:&lt;/span&gt;8080 &lt;span class="n"&gt;weight&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;50 &lt;span class="n"&gt;fail_timeout&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;30&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="n"&gt;server&lt;/span&gt; 192&lt;span class="p"&gt;.&lt;/span&gt;168&lt;span class="p"&gt;.&lt;/span&gt;1&lt;span class="p"&gt;.&lt;/span&gt;11&lt;span class="p"&gt;:&lt;/span&gt;8080 &lt;span class="n"&gt;weight&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;50 &lt;span class="n"&gt;fail_timeout&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;30&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;两边nginx一样配置. 平衡权重,实现负载均衡&lt;/p&gt;
&lt;p&gt;安装&lt;strong&gt;keepalived&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;安装过程很简单, 经典的编译 三部曲&lt;/p&gt;
&lt;p&gt;如此安装是通用的.. 如果你不需要lvs功能, 你可以将lvs去掉&lt;/p&gt;
&lt;p&gt;&lt;code&gt;./configure –prefix=/opt/keepalived –disable-lvs-syncd –disable-lvs&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;cp 编译目录/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;接下来是重点部分, 就是配置..&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="sx"&gt;! Configuration File for keepalived&lt;/span&gt;

&lt;span class="n"&gt;global_defs&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; #全局配置
&lt;span class="n"&gt;router_id&lt;/span&gt; &lt;span class="n"&gt;nginx_ha&lt;/span&gt; #唯一名称
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;vrrp_script&lt;/span&gt; &lt;span class="n"&gt;check&lt;/span&gt; &lt;span class="n"&gt;httpcheck&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt; #实例脚本
&lt;span class="n"&gt;script&lt;/span&gt; “&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;script&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;check_http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;” #脚本路径
&lt;span class="n"&gt;interval&lt;/span&gt; 60 #间隔
&lt;span class="n"&gt;weight&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;100 #权重
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;vrrp_instance&lt;/span&gt; &lt;span class="n"&gt;VI_2&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; #&lt;span class="n"&gt;VRRP&lt;/span&gt;实例&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;instance&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="n"&gt;BACKUP&lt;/span&gt; #初始状态
&lt;span class="n"&gt;interface&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt; #网络接口
&lt;span class="n"&gt;virtual_router_id&lt;/span&gt; 60 #&lt;span class="n"&gt;VRID&lt;/span&gt;，这里非常重要，相同的&lt;span class="n"&gt;VRID&lt;/span&gt;为一个组，他将决定多播的&lt;span class="n"&gt;MAC&lt;/span&gt;地址
#&lt;span class="n"&gt;nopreempt&lt;/span&gt; #设置不抢占，这里只能设置在&lt;span class="n"&gt;state&lt;/span&gt;为&lt;span class="n"&gt;backup&lt;/span&gt;的节点上，而且这个节点的优先级必须别另外的高
&lt;span class="n"&gt;priority&lt;/span&gt; 150 # 优先级
&lt;span class="n"&gt;advert_int&lt;/span&gt; 1 检查间隔，默认为1秒
&lt;span class="n"&gt;notify_master&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;script&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;master&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt; #当它是&lt;span class="n"&gt;master&lt;/span&gt;时 运行的脚本
&lt;span class="n"&gt;notify_backup&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;script&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;backup&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt; #当它是&lt;span class="n"&gt;backup&lt;/span&gt;时 运行的脚本
&lt;span class="n"&gt;virtual_ipaddress&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; #&lt;span class="n"&gt;VIP&lt;/span&gt;
192&lt;span class="p"&gt;.&lt;/span&gt;168&lt;span class="p"&gt;.&lt;/span&gt;4&lt;span class="p"&gt;.&lt;/span&gt;3&lt;span class="o"&gt;/&lt;/span&gt;24 &lt;span class="n"&gt;dev&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt; &lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="k"&gt;global&lt;/span&gt; &lt;span class="n"&gt;label&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;1
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;authentication&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; #设置认证
&lt;span class="n"&gt;auth_type&lt;/span&gt; &lt;span class="n"&gt;PASS&lt;/span&gt; #认证类型&lt;span class="p"&gt;,&lt;/span&gt;可以是&lt;span class="n"&gt;PASS&lt;/span&gt;或&lt;span class="n"&gt;AH&lt;/span&gt;两种认证方式
&lt;span class="n"&gt;auth_pass&lt;/span&gt; &lt;span class="o"&gt;***&lt;/span&gt; #认证密码
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="n"&gt;track_script&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; # 在实例&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;vrrp_instance&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;里面引用，有点类似脚本里面的函数引用一样：先定义，后引用函数名
&lt;span class="n"&gt;httpcheck&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;同样的配置在B机器也配置一份,&lt;/p&gt;
&lt;p&gt;最后在A机器上启动 &lt;code&gt;/etc/init.d/keepalived&lt;/code&gt;&lt;/p&gt;
&lt;h3&gt;观察日志&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Starting&lt;/span&gt; &lt;span class="n"&gt;Keepalived&lt;/span&gt; &lt;span class="n"&gt;v1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;2&lt;span class="p"&gt;.&lt;/span&gt;2 &lt;span class="p"&gt;(&lt;/span&gt;10&lt;span class="o"&gt;/&lt;/span&gt;18&lt;span class="p"&gt;,&lt;/span&gt;2012&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Starting&lt;/span&gt; &lt;span class="n"&gt;Healthcheck&lt;/span&gt; &lt;span class="n"&gt;child&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;5837
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Registering&lt;/span&gt; &lt;span class="n"&gt;Kernel&lt;/span&gt; &lt;span class="n"&gt;netlink&lt;/span&gt; &lt;span class="n"&gt;reflector&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Registering&lt;/span&gt; &lt;span class="n"&gt;Kernel&lt;/span&gt; &lt;span class="n"&gt;netlink&lt;/span&gt; &lt;span class="n"&gt;command&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Registering&lt;/span&gt; &lt;span class="n"&gt;gratutious&lt;/span&gt; &lt;span class="n"&gt;ARP&lt;/span&gt; &lt;span class="n"&gt;shared&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Starting&lt;/span&gt; &lt;span class="n"&gt;VRRP&lt;/span&gt; &lt;span class="n"&gt;child&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;5839
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;IPVS&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Registered&lt;/span&gt; &lt;span class="n"&gt;protocols&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;TCP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;UDP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;AH&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ESP&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;IPVS&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Connection&lt;/span&gt; &lt;span class="n"&gt;hash&lt;/span&gt; &lt;span class="n"&gt;table&lt;/span&gt; &lt;span class="n"&gt;configured&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;size&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;4096&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;memory&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;32&lt;span class="n"&gt;Kbytes&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;IPVS&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;ipvs&lt;/span&gt; &lt;span class="n"&gt;loaded&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_healthcheckers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Registering&lt;/span&gt; &lt;span class="n"&gt;Kernel&lt;/span&gt; &lt;span class="n"&gt;netlink&lt;/span&gt; &lt;span class="n"&gt;reflector&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_healthcheckers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Registering&lt;/span&gt; &lt;span class="n"&gt;Kernel&lt;/span&gt; &lt;span class="n"&gt;netlink&lt;/span&gt; &lt;span class="n"&gt;command&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_healthcheckers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Opening&lt;/span&gt; &lt;span class="n"&gt;file&lt;/span&gt; ‘&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;conf&lt;/span&gt;’&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Opening&lt;/span&gt; &lt;span class="n"&gt;file&lt;/span&gt; ‘&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;conf&lt;/span&gt;’&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Configuration&lt;/span&gt; &lt;span class="n"&gt;is&lt;/span&gt; &lt;span class="n"&gt;using&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; 36252 &lt;span class="n"&gt;Bytes&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Using&lt;/span&gt; &lt;span class="n"&gt;LinkWatch&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt; &lt;span class="n"&gt;netlink&lt;/span&gt; &lt;span class="n"&gt;reflector&lt;/span&gt;…
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_healthcheckers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Configuration&lt;/span&gt; &lt;span class="n"&gt;is&lt;/span&gt; &lt;span class="n"&gt;using&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; 6271 &lt;span class="n"&gt;Bytes&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_healthcheckers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Using&lt;/span&gt; &lt;span class="n"&gt;LinkWatch&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt; &lt;span class="n"&gt;netlink&lt;/span&gt; &lt;span class="n"&gt;reflector&lt;/span&gt;…
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;VRRP_Instance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;VI_2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;Entering&lt;/span&gt; &lt;span class="n"&gt;BACKUP&lt;/span&gt; &lt;span class="n"&gt;STATE&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;同样的在B机器启动 keepalived&lt;/p&gt;
&lt;h3&gt;观察日志&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Starting&lt;/span&gt; &lt;span class="n"&gt;Keepalived&lt;/span&gt; &lt;span class="n"&gt;v1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;2&lt;span class="p"&gt;.&lt;/span&gt;2 &lt;span class="p"&gt;(&lt;/span&gt;10&lt;span class="o"&gt;/&lt;/span&gt;18&lt;span class="p"&gt;,&lt;/span&gt;2012&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Starting&lt;/span&gt; &lt;span class="n"&gt;Healthcheck&lt;/span&gt; &lt;span class="n"&gt;child&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;5837
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Registering&lt;/span&gt; &lt;span class="n"&gt;Kernel&lt;/span&gt; &lt;span class="n"&gt;netlink&lt;/span&gt; &lt;span class="n"&gt;reflector&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Registering&lt;/span&gt; &lt;span class="n"&gt;Kernel&lt;/span&gt; &lt;span class="n"&gt;netlink&lt;/span&gt; &lt;span class="n"&gt;command&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Registering&lt;/span&gt; &lt;span class="n"&gt;gratutious&lt;/span&gt; &lt;span class="n"&gt;ARP&lt;/span&gt; &lt;span class="n"&gt;shared&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Starting&lt;/span&gt; &lt;span class="n"&gt;VRRP&lt;/span&gt; &lt;span class="n"&gt;child&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;5839
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;IPVS&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Registered&lt;/span&gt; &lt;span class="n"&gt;protocols&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;TCP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;UDP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;AH&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ESP&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;IPVS&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Connection&lt;/span&gt; &lt;span class="n"&gt;hash&lt;/span&gt; &lt;span class="n"&gt;table&lt;/span&gt; &lt;span class="n"&gt;configured&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;size&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;4096&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;memory&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;32&lt;span class="n"&gt;Kbytes&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;IPVS&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;ipvs&lt;/span&gt; &lt;span class="n"&gt;loaded&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_healthcheckers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Registering&lt;/span&gt; &lt;span class="n"&gt;Kernel&lt;/span&gt; &lt;span class="n"&gt;netlink&lt;/span&gt; &lt;span class="n"&gt;reflector&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_healthcheckers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Registering&lt;/span&gt; &lt;span class="n"&gt;Kernel&lt;/span&gt; &lt;span class="n"&gt;netlink&lt;/span&gt; &lt;span class="n"&gt;command&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_healthcheckers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Opening&lt;/span&gt; &lt;span class="n"&gt;file&lt;/span&gt; ‘&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;conf&lt;/span&gt;’&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Opening&lt;/span&gt; &lt;span class="n"&gt;file&lt;/span&gt; ‘&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;opt&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;conf&lt;/span&gt;’&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Configuration&lt;/span&gt; &lt;span class="n"&gt;is&lt;/span&gt; &lt;span class="n"&gt;using&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; 36252 &lt;span class="n"&gt;Bytes&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Using&lt;/span&gt; &lt;span class="n"&gt;LinkWatch&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt; &lt;span class="n"&gt;netlink&lt;/span&gt; &lt;span class="n"&gt;reflector&lt;/span&gt;…
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_healthcheckers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Configuration&lt;/span&gt; &lt;span class="n"&gt;is&lt;/span&gt; &lt;span class="n"&gt;using&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; 6271 &lt;span class="n"&gt;Bytes&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_healthcheckers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Using&lt;/span&gt; &lt;span class="n"&gt;LinkWatch&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt; &lt;span class="n"&gt;netlink&lt;/span&gt; &lt;span class="n"&gt;reflector&lt;/span&gt;…
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;30&lt;span class="p"&gt;:&lt;/span&gt;02 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;VRRP_Instance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;VI_2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;Entering&lt;/span&gt; &lt;span class="n"&gt;BACKUP&lt;/span&gt; &lt;span class="n"&gt;STATE&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;从日志可以看出，启动都没有问题，并且安装我给的优先级完成了竞选，各自成就了各自的状态 &lt;/p&gt;
&lt;p&gt;关闭节点A的网卡测试切换是否正常&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ifdown eth0&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;观察节点B的日志：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;32&lt;span class="p"&gt;:&lt;/span&gt;55 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;VRRP_Instance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;VI_2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;Transition&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;MASTER&lt;/span&gt; &lt;span class="n"&gt;STATE&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;33&lt;span class="p"&gt;:&lt;/span&gt;00 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;VRRP_Instance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;VI_2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;Entering&lt;/span&gt; &lt;span class="n"&gt;MASTER&lt;/span&gt; &lt;span class="n"&gt;STATE&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;33&lt;span class="p"&gt;:&lt;/span&gt;00 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;avahi&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;daemon&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;2531&lt;span class="p"&gt;]:&lt;/span&gt; &lt;span class="n"&gt;Registering&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt; &lt;span class="n"&gt;record&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; 192&lt;span class="p"&gt;.&lt;/span&gt;168&lt;span class="p"&gt;.&lt;/span&gt;4&lt;span class="p"&gt;.&lt;/span&gt;3 &lt;span class="n"&gt;on&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;启动节点A的网卡测试切换是否正常&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ifup eth0&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;观察节点B的日志：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;33&lt;span class="p"&gt;:&lt;/span&gt;31 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;VRRP_Instance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;VI_2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;Received&lt;/span&gt; &lt;span class="n"&gt;higher&lt;/span&gt; &lt;span class="n"&gt;prio&lt;/span&gt; &lt;span class="n"&gt;advert&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;33&lt;span class="p"&gt;:&lt;/span&gt;31 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;Keepalived_vrrp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;VRRP_Instance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;VI_2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;Entering&lt;/span&gt; &lt;span class="n"&gt;BACKUP&lt;/span&gt; &lt;span class="n"&gt;STATE&lt;/span&gt;
&lt;span class="n"&gt;Sep&lt;/span&gt; 8 18&lt;span class="p"&gt;:&lt;/span&gt;33&lt;span class="p"&gt;:&lt;/span&gt;31 &lt;span class="n"&gt;centosb&lt;/span&gt; &lt;span class="n"&gt;avahi&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;daemon&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;2531&lt;span class="p"&gt;]:&lt;/span&gt; &lt;span class="n"&gt;Withdrawing&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt; &lt;span class="n"&gt;record&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; 192&lt;span class="p"&gt;.&lt;/span&gt;168&lt;span class="p"&gt;.&lt;/span&gt;4&lt;span class="p"&gt;.&lt;/span&gt;3 &lt;span class="n"&gt;on&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;strong&gt;Received higher prio advert&lt;/strong&gt; 表示接收到更高优先级的公告(advert公告的意思)&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Withdrawing&lt;/strong&gt; 撤回的意思，可以看出切换过程一目了然&lt;/p&gt;
&lt;p&gt;现在我们监控了网络故障和keepalived本身进程，在网络或者keepalived进程出现问题的时候会切换,
但是我的目的是要实现nginx的高可用, 一旦A,B任何一台nginx挂了, 我要无缝切换.. 这里就需要用到脚本&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;/opt/keepalived/etc/keepalived/script/check_http.sh&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这个脚本 就是用来监控nginx的.&lt;/p&gt;
&lt;p&gt;大概内容就是, 先检查本机的nginx进程是否存在&lt;/p&gt;
&lt;p&gt;&lt;code&gt;if [ 'ps -ef |grep nginx|wc -l' -ne 0 ]&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;然后检查nginx的端口是否开放&lt;/p&gt;
&lt;p&gt;&lt;code&gt;nc -z -vv 192.168.2.12 80 &amp;gt; /dev/null &amp;amp;&amp;amp; status=$? &amp;amp;&amp;amp; if [ $status -ne 0 ] ;then /etc/init.d/keepalived stop ;fi&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;一旦,进程或者端口不存在,或者没开放, 我们就认为nginx服务不可用了, 于是在脚本里面就执行 &lt;/p&gt;
&lt;p&gt;&lt;code&gt;/etc/init.d/keepalived stop&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;将keepalived停掉. 然后另外一台keepalived就会将VIP给抢过去.继续服务..&lt;/p&gt;
&lt;p&gt;从上面的架构图可以看得出来.. 我们dns是解析在VIP上的, 所以, 只要两台机器任意一
台机器存活, 我们&lt;em&gt;VIP&lt;/em&gt;都不会断网, 我们的nginx的服务 就可以一直提供..&lt;/p&gt;</summary><category term="nginx"></category><category term="运维"></category></entry><entry><title>Keepalived原理与实战精讲</title><link href="http://eleveni386.7axu.com/posts/2012/10/16/keepalivedyuan-li-yu-shi-zhan-jing-jiang/" rel="alternate"></link><updated>2012-10-16T00:00:00+08:00</updated><author><name>eleven.i386</name></author><id>tag:eleveni386.7axu.com,2012-10-16:posts/2012/10/16/keepalivedyuan-li-yu-shi-zhan-jing-jiang/</id><summary type="html">&lt;p&gt;&lt;strong&gt;此为转贴&lt;/strong&gt;
&lt;a href="http://bbs.ywlm.net/thread-845-1-1.html"&gt;原文地址&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="/image/Keepalived.png" /&gt;&lt;/p&gt;</summary><category term="运维"></category><category term="keepalived"></category></entry><entry><title>记. 一次邮箱密码丢失</title><link href="http://eleveni386.7axu.com/posts/2012/09/17/ji-ci-you-xiang-mi-ma-diu-shi/" rel="alternate"></link><updated>2012-09-17T00:00:00+08:00</updated><author><name>eleven.i386</name></author><id>tag:eleveni386.7axu.com,2012-09-17:posts/2012/09/17/ji-ci-you-xiang-mi-ma-diu-shi/</id><summary type="html">&lt;p&gt;话说某年某月某天, 某人丢失公司分配的邮箱密码,&lt;/p&gt;
&lt;p&gt;在虚拟机中的windows,用foxmail客户端, 因为某些原因密码丢失,而公司邮件又需要用
该客户端发送,于是就有了下面的过程,&lt;/p&gt;
&lt;p&gt;在物理机中的雷鸟客户端保存了密码, 首先需要客户端上的密码加密,主要是smtp密码传输加密&lt;/p&gt;
&lt;p&gt;好了,然后就用&lt;strong&gt;tcpdump&lt;/strong&gt; 就可以了,&lt;/p&gt;
&lt;p&gt;&lt;code&gt;tcpdump -X -i eth0 port 587 -vv&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;TLS/STARTTLS 端口是587 ,雷鸟和foxmail都自动认出来端口是587,所以我也捕抓发往587端口的数据&lt;/p&gt;
&lt;p&gt;从结果中分析,下图是客户端跟服务端验证过程&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="/image/2012-09-17-163233_1365x306_scrot1.png" /&gt;&lt;/p&gt;
&lt;p&gt;得到一个base64的密码,&lt;/p&gt;
&lt;p&gt;&lt;code&gt;echo -n "password" | base64 -d&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;解开就是明文密码&lt;/p&gt;</summary><category term="密码"></category><category term="邮箱"></category><category term="安全"></category></entry></feed>